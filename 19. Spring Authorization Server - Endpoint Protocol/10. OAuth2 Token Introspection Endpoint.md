-----
### OAuth2TokenIntorspectionEndpointConfigurer
-----
1. OAuth2 í† í° ê²€ì‚¬ ì—”ë“œí¬ì¸íŠ¸ì— ëŒ€í•œ ì‚¬ìš©ì ì •ì˜í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ ì œê³µ
2. OAuth2 ê²€ì‚¬ ìš”ì²­ì— ëŒ€í•œ ì „ì²˜ë¦¬, ê¸°ë³¸ ì²˜ë¦¬ ë° í›„ì²˜ë¦¬ ë¡œì§ì„ ì»¤ìŠ¤í…€í•˜ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆë„ë¡ API ì§€ì›
3. OAuth2TokenIntrospectionEndpointFilterë¥¼ êµ¬ì„±í•˜ê³ , ì´ë¥¼ OAuth2 ì¸ì¦ ì„œë²„ SecurityFilterChain ë¹ˆì— ë“±ë¡

-----
### OAuth2TokenIntrospectionEndpointFilter
-----
1. OAuth2 ê²€ì‚¬ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” í•„í„°
2. ê¸°ë³¸ê°’
   - IntrospectionRequestConverter : OAuth2 ê²€ì‚¬ ìš”ì²­ì„ ì¶”ì¶œí•˜ë ¤ê³  í•  ë•Œ, ì‚¬ìš©ë˜ëŠ” ì „ì²˜ë¦¬ê¸°ë¡œì„œ, OAuth2TokenIntrospectionAuthenticationToken ë°˜í™˜
   - OAuth2TokenIntrospectionAuthenticationProvider : OAuth2TokenIntrospectionAuthenticationTokenë¥¼ ë°›ì•„ ì¸ì¦ ì²˜ë¦¬ë¥¼ í•˜ëŠ” AuthenticationProvider êµ¬í˜„ì²´

-----
### RequestMatcher
-----
: í† í° ê²€ì‚¬ ìš”ì²­ íŒ¨í„´ - POST /oauth2/introspect

-----
### OAuth 2.0 Token Introspection Endpoint íë¦„ë„
-----
<div align="center">
<img src="https://github.com/user-attachments/assets/e209ea05-4b3a-4b6a-8203-9992839789f3">
</div>

1. ìš”ì²­í•˜ëŠ” ì£¼ì²´(Client)ëŠ” Resource Server
2. Authorization ServerëŠ” ì´ í† í°ì— ëŒ€í•´ í™œì„±í™” ì—¬ë¶€ë¥¼ ë³´ëŠ” ê²ƒ (ê²€ì¦)
3. ğŸ’¡ í† í° ìš”ì²­ / ê²€ì‚¬ / í•´ì§€ ëª¨ë‘ í´ë¼ì´ì–¸íŠ¸ì˜ ì¸ì¦ì„ ë°›ì•„ì•¼ í•¨ (clientPrincipal ì¡´ì¬)
4. OAuth2Authorizationì—ì„œëŠ” í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë°œí–‰í•œ Access Token ê°’ì„ ì €ì¥í•˜ê³  ìˆëŠ”ë°, ì´ë¥¼ ê°€ì ¸ì™€ OAuth2TokenIntrospectionAuthenticationProviderë¡œ ê°€ì ¸ì™€, ìš”ì²­ ê°’ê³¼ ë¹„êµ
5. claim ì¤‘, nbf ì‚¬ìš© ì´ì „ì˜ ì‹œê°„ì´ë©´, isBeforeUse()ëŠ” false (ì„¸ ì¡°ê±´ ì¤‘ í•˜ë‚˜ë¼ë„ falseë¼ë©´, ì˜ˆì™¸ ë°œìƒ)

-----
### ì‚¬ìš©ì ì •ì˜ ê¸°ëŠ¥
-----
<div align="center">
<img src="https://github.com/user-attachments/assets/a97553e2-9fa8-4e49-8024-80372d6644a7">
</div>

-----
### ì½”ë“œ
-----
1. AuthorizationServerì™€ ResourceServerë¡œ ë‚˜ëˆ ì„œ êµ¬ì„±
   - ResourceServer
     + build.gradle
```gradle
plugins {
    id 'org.springframework.boot' version '2.7.1'
    id 'io.spring.dependency-management' version '1.0.11.RELEASE'
    id 'java'
}

group = 'io.security.oauth2'
version = '0.0.1-SNAPSHOT'
sourceCompatibility = '11'

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-oauth2-resource-server'
    runtimeOnly 'com.nimbusds:oauth2-oidc-sdk:9.35'
    implementation 'org.projectlombok:lombok:1.18.22'
    annotationProcessor 'org.projectlombok:lombok:1.18.22'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testImplementation 'org.springframework.security:spring-security-test'
}

tasks.named('test') {
    useJUnitPlatform()
}
```

   + application.yml
```yml
server:
  port: 8081

spring:
  security:
    oauth2:
      resourceserver:
        opaquetoken:
          introspection-uri: http://localhost:9000/oauth2/introspect ## Spring Security ì¸ê°€ ì„œë²„ token ê²€ì‚¬ ì—”ë“œí¬ì¸íŠ¸
          client-id: oauth2-client-app1
          client-secret: secret1
```

   + OpaqueDto
```java
package io.security.oauth2.springsecurityoauth2;

import lombok.Data;
import org.springframework.security.core.Authentication;

@Data
public class OpaqueDto {
    private boolean active;
    private Authentication authentication;
    private Object principal;
}
```

   + OAuth2ResourceServer
```java
package io.security.oauth2.springsecurityoauth2;

import org.springframework.boot.autoconfigure.security.oauth2.resource.OAuth2ResourceServerProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configurers.oauth2.server.resource.OAuth2ResourceServerConfigurer;
import org.springframework.security.oauth2.server.resource.introspection.NimbusOpaqueTokenIntrospector;
import org.springframework.security.oauth2.server.resource.introspection.OpaqueTokenIntrospector;
import org.springframework.security.web.SecurityFilterChain;

@Configuration(proxyBeanMethods = false)
public class OAuth2ResourceServer {

    @Bean
    SecurityFilterChain securityFilterChain1(HttpSecurity http) throws Exception {

        http.authorizeRequests(
                (requests) -> requests.anyRequest().authenticated());
        http.oauth2ResourceServer(OAuth2ResourceServerConfigurer::opaqueToken);
        return http.build();

    }

    @Bean
    public OpaqueTokenIntrospector nimbusOpaqueTokenIntrospector(OAuth2ResourceServerProperties properties) {
        OAuth2ResourceServerProperties.Opaquetoken opaquetoken = properties.getOpaquetoken();
        return new NimbusOpaqueTokenIntrospector(opaquetoken.getIntrospectionUri(),opaquetoken.getClientId(),opaquetoken.getClientSecret()); // Opaque êµ¬í˜„ì²´ (í† í° ê²€ì‚¬)
    }
}
```

  + IndexController ((Opaque) í† í° ê²€ì‚¬ê°€ ì™„ë£Œ ë˜ë©´, /introspectë¡œ ì´ë™)
```java
package io.security.oauth2.springsecurityoauth2;

import org.springframework.security.core.Authentication;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.oauth2.core.OAuth2AuthenticatedPrincipal;
import org.springframework.security.oauth2.server.resource.authentication.BearerTokenAuthentication;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.Map;

@RestController
public class IndexController {
    @GetMapping("/introspect")
    public OpaqueDto index(Authentication authentication, @AuthenticationPrincipal OAuth2AuthenticatedPrincipal principal){
        BearerTokenAuthentication bearerTokenAuthentication =  (BearerTokenAuthentication)authentication;
        Map<String, Object> tokenAttributes = bearerTokenAuthentication.getTokenAttributes();
        boolean active = (boolean)tokenAttributes.get("active");
        OpaqueDto opaqueDto = new OpaqueDto();
        opaqueDto.setActive(active);
        opaqueDto.setAuthentication(bearerTokenAuthentication);
        opaqueDto.setPrincipal(principal);
        return opaqueDto;
    }
}
```

2. ResourceServer
   - OAuth2ResourceServerConfigurer
```java
public void init(H http) {
        this.validateConfiguration();
        this.registerDefaultAccessDeniedHandler(http);
        this.registerDefaultEntryPoint(http);
        this.registerDefaultCsrfOverride(http);
        AuthenticationProvider authenticationProvider = this.getAuthenticationProvider(); // Opaque í† í° ê²€ì¦í•˜ëŠ” AuthenticationProvider (OpaqueTokenAuthenticationProvider)
        if (authenticationProvider != null) {
            http.authenticationProvider(authenticationProvider);
        }

}
```

  - BearerTokenAuthenticationFilter
```java
protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        String token;
        try {
            token = this.bearerTokenResolver.resolve(request); // í† í°ì„ Parsingí•´ì„œ ì²˜ë¦¬ (ì¸ê°€ ì„œë²„ë¡œ ì „ì†¡í•˜ê¸° ìœ„í•¨)
        } catch (OAuth2AuthenticationException var10) {
            OAuth2AuthenticationException invalid = var10;
            this.logger.trace("Sending to authentication entry point since failed to resolve bearer token", invalid);
            this.authenticationEntryPoint.commence(request, response, invalid);
            return;
        }

        if (token == null) {
            this.logger.trace("Did not process request since did not find bearer token");
            filterChain.doFilter(request, response);
        } else {
            BearerTokenAuthenticationToken authenticationRequest = new BearerTokenAuthenticationToken(token); // ì¸ì¦ ì²˜ë¦¬ ì‹œì‘
            authenticationRequest.setDetails(this.authenticationDetailsSource.buildDetails(request));

            try {
                AuthenticationManager authenticationManager = this.authenticationManagerResolver.resolve(request); // AuthenticationManagerì—ê²Œ ì „ë‹¬ (OpaqueTokenAuthenticationProvider)
                Authentication authenticationResult = authenticationManager.authenticate(authenticationRequest);
                SecurityContext context = SecurityContextHolder.createEmptyContext();
                context.setAuthentication(authenticationResult);
                SecurityContextHolder.setContext(context);
                this.securityContextRepository.saveContext(context, request, response);
                if (this.logger.isDebugEnabled()) {
                    this.logger.debug(LogMessage.format("Set SecurityContextHolder to %s", authenticationResult));
                }

                filterChain.doFilter(request, response);
            } catch (AuthenticationException var9) {
                AuthenticationException failed = var9;
                SecurityContextHolder.clearContext();
                this.logger.trace("Failed to process authentication request", failed);
                this.authenticationFailureHandler.onAuthenticationFailure(request, response, failed);
            }

        }
}
```

  - OpaqueTokenAuthenticationProvider
```java
public Authentication authenticate(Authentication authentication) throws AuthenticationException {
        if (!(authentication instanceof BearerTokenAuthenticationToken)) {
            return null;
        } else {
            BearerTokenAuthenticationToken bearer = (BearerTokenAuthenticationToken)authentication;
            OAuth2AuthenticatedPrincipal principal = this.getOAuth2AuthenticatedPrincipal(bearer);
            AbstractAuthenticationToken result = this.convert(principal, bearer.getToken());
            result.setDetails(bearer.getDetails());
            this.logger.debug("Authenticated token");
            return result;
        }
}

private OAuth2AuthenticatedPrincipal getOAuth2AuthenticatedPrincipal(BearerTokenAuthenticationToken bearer) {
        try {
            return this.introspector.introspect(bearer.getToken()); // NimbusOpaqueTokenIntrospector
        } catch (BadOpaqueTokenException var3) {
            BadOpaqueTokenException failed = var3;
            this.logger.debug("Failed to authenticate since token was invalid");
            throw new InvalidBearerTokenException(failed.getMessage(), failed);
        } catch (OAuth2IntrospectionException var4) {
            OAuth2IntrospectionException failed = var4;
            throw new AuthenticationServiceException(failed.getMessage(), failed);
        }
}
```

  - NimbusOpaqueTokenIntrospector
```java
public OAuth2AuthenticatedPrincipal introspect(String token) {
        RequestEntity<?> requestEntity = (RequestEntity)this.requestEntityConverter.convert(token); // RequestEntity
        if (requestEntity == null) {
            throw new OAuth2IntrospectionException("requestEntityConverter returned a null entity");
        } else {
            ResponseEntity<String> responseEntity = this.makeRequest(requestEntity); // ìš”ì²­ ì „ì†¡ (POST /oaut2/introspect)
            HTTPResponse httpResponse = this.adaptToNimbusResponse(responseEntity);
            TokenIntrospectionResponse introspectionResponse = this.parseNimbusResponse(httpResponse);
            TokenIntrospectionSuccessResponse introspectionSuccessResponse = this.castToNimbusSuccess(introspectionResponse);
            if (!introspectionSuccessResponse.isActive()) {
                this.logger.trace("Did not validate token since it is inactive");
                throw new BadOpaqueTokenException("Provided token isn't active");
            } else {
                return this.convertClaimsSet(introspectionSuccessResponse);
            }
        }
}
```

3. AuthorizationServer
   - OAuth2TokenIntrospectionEndpointFilter
```java
private static final String DEFAULT_TOKEN_INTROSPECTION_ENDPOINT_URI = "/oauth2/introspect";
    
protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        if (!this.tokenIntrospectionEndpointMatcher.matches(request)) {
            filterChain.doFilter(request, response);
        } else {
            try {
                Authentication tokenIntrospectionAuthentication = this.authenticationConverter.convert(request); // DefaultTokenIntrospectionAuthenticationConverter
                Authentication tokenIntrospectionAuthenticationResult = this.authenticationManager.authenticate(tokenIntrospectionAuthentication); // ê²°ê³¼ ê°ì²´ë¥¼ ë§Œë“  ë’¤, ProvdierManagerì—ê²Œ ì „ë‹¬ -> OAuth2TokenIntrospectionAuthenticationProvider
                this.authenticationSuccessHandler.onAuthenticationSuccess(request, response, tokenIntrospectionAuthenticationResult); /
            } catch (OAuth2AuthenticationException var6) {
                OAuth2AuthenticationException ex = var6;
                SecurityContextHolder.clearContext();
                this.authenticationFailureHandler.onAuthenticationFailure(request, response, ex);
            }

        }
}

...

private static class DefaultTokenIntrospectionAuthenticationConverter implements AuthenticationConverter {
        private DefaultTokenIntrospectionAuthenticationConverter() {
        }

        public Authentication convert(HttpServletRequest request) {
            Authentication clientPrincipal = SecurityContextHolder.getContext().getAuthentication(); // ì¸ì¦ ê°ì²´ ì¶”ì¶œ
            MultiValueMap<String, String> parameters = OAuth2EndpointUtils.getParameters(request); // íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜´
            String token = (String)parameters.getFirst("token"); // Resource Serverì—ì„œ ë³´ë‚¸ token
            if (!StringUtils.hasText(token) || ((List)parameters.get("token")).size() != 1) {
                OAuth2TokenIntrospectionEndpointFilter.throwError("invalid_request", "token");
            }

            String tokenTypeHint = (String)parameters.getFirst("token_type_hint"); // optional (token type íŒíŠ¸)
            if (StringUtils.hasText(tokenTypeHint) && ((List)parameters.get("token_type_hint")).size() != 1) {
                OAuth2TokenIntrospectionEndpointFilter.throwError("invalid_request", "token_type_hint");
            }

            Map<String, Object> additionalParameters = new HashMap();
            parameters.forEach((key, value) -> {
                if (!key.equals("token") && !key.equals("token_type_hint")) {
                    additionalParameters.put(key, value.get(0));
                }

            });
            return new OAuth2TokenIntrospectionAuthenticationToken(token, clientPrincipal, tokenTypeHint, additionalParameters); // ì¸ì¦ ê°ì²´ ë§Œë“¬ 
        }
}

...

private void sendIntrospectionResponse(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException { // ëª¨ë“  ì²˜ë¦¬ê°€ ì •ìƒì  ì²˜ë¦¬ë˜ë©´,
        OAuth2TokenIntrospectionAuthenticationToken tokenIntrospectionAuthentication = (OAuth2TokenIntrospectionAuthenticationToken)authentication;
        OAuth2TokenIntrospection tokenClaims = tokenIntrospectionAuthentication.getTokenClaims();
        ServletServerHttpResponse httpResponse = new ServletServerHttpResponse(response);
        this.tokenIntrospectionHttpResponseConverter.write(tokenClaims, (MediaType)null, httpResponse); // Resource Serverë¡œ ë‹¤ì‹œ ì „ì†¡
  }  
```

  - OAuth2TokenIntrospectionAuthenticationProvider
```java
public Authentication authenticate(Authentication authentication) throws AuthenticationException {
        OAuth2TokenIntrospectionAuthenticationToken tokenIntrospectionAuthentication = (OAuth2TokenIntrospectionAuthenticationToken)authentication;
        OAuth2ClientAuthenticationToken clientPrincipal = OAuth2AuthenticationProviderUtils.getAuthenticatedClientElseThrowInvalidClient(tokenIntrospectionAuthentication);

        // tokenIntrospectionAuthentication : Resource Serverì—ì„œ ë³´ë‚¸ í† í° ê°’ê³¼ ë¹„êµ
        OAuth2Authorization authorization = this.authorizationService.findByToken(tokenIntrospectionAuthentication.getToken(), (OAuth2TokenType)null); // OAuth2Authorizationì—ì„œ í† í°ì„ ê°€ì ¸ì˜´ (ì„ì‹œ ì½”ë“œë¥¼ ê°€ì ¸ì˜¬ ë•Œì˜ ê°’) - ì¸ê°€ ì„œë²„ê°€ ë°œí–‰í•œ ê°’
        if (authorization == null) {
            return tokenIntrospectionAuthentication;
        } else {
            OAuth2Authorization.Token<OAuth2Token> authorizedToken = authorization.getToken(tokenIntrospectionAuthentication.getToken());
            if (!authorizedToken.isActive()) { // í™œì„±í™” ì—¬ë¶€ í™•ì¸ (OAuth2Authorization)
                return new OAuth2TokenIntrospectionAuthenticationToken(tokenIntrospectionAuthentication.getToken(), clientPrincipal, OAuth2TokenIntrospection.builder().build()); // í•˜ë‚˜ë¼ë„ ì¡°ê±´ì— ë¶€í•©í•˜ì§€ ëª»í•˜ë©´ ì˜ˆì™¸ ë°œìƒ (401 Unauthorized)
            } else {
                RegisteredClient authorizedClient = this.registeredClientRepository.findById(authorization.getRegisteredClientId()); // ì¸ê°€ì„œë²„ì— ë“±ë¡ëœ í´ë¼ì´ì–¸íŠ¸ ì •ë³´ ê°€ì ¸ì˜´
                OAuth2TokenIntrospection tokenClaims = withActiveTokenClaims(authorizedToken, authorizedClient); // tokenClaimsì—ì„œ active = true ë“±ë¡
                return new OAuth2TokenIntrospectionAuthenticationToken(authorizedToken.getToken().getTokenValue(), clientPrincipal, tokenClaims); // OAuth2TokenIntrospectionAuthenticationToken ìƒì„±
            }
        }
}

private static OAuth2TokenIntrospection withActiveTokenClaims(OAuth2Authorization.Token<OAuth2Token> authorizedToken, RegisteredClient authorizedClient) {
        OAuth2TokenIntrospection.Builder tokenClaims;
        if (!CollectionUtils.isEmpty(authorizedToken.getClaims())) {
            Map<String, Object> claims = convertClaimsIfNecessary(authorizedToken.getClaims());
            tokenClaims = OAuth2TokenIntrospection.withClaims(claims).active(true);
        } else {
            tokenClaims = OAuth2TokenIntrospection.builder(true);
        }

        tokenClaims.clientId(authorizedClient.getClientId());
        OAuth2Token token = authorizedToken.getToken();
        if (token.getIssuedAt() != null) {
            tokenClaims.issuedAt(token.getIssuedAt());
        }

        if (token.getExpiresAt() != null) {
            tokenClaims.expiresAt(token.getExpiresAt());
        }

        if (OAuth2AccessToken.class.isAssignableFrom(token.getClass())) {
            OAuth2AccessToken accessToken = (OAuth2AccessToken)token;
            tokenClaims.tokenType(accessToken.getTokenType().getValue());
        }

        return tokenClaims.build();
}
```

  - OAuth2Authorization
```java
public boolean isActive() {
            return !this.isInvalidated() && !this.isExpired() && !this.isBeforeUse();
}
```

4. Resource Server
  - NimbusOpaqueTokenIntrospector
```java
public OAuth2AuthenticatedPrincipal introspect(String token) {
        RequestEntity<?> requestEntity = (RequestEntity)this.requestEntityConverter.convert(token);
        if (requestEntity == null) {
            throw new OAuth2IntrospectionException("requestEntityConverter returned a null entity");
        } else {
            ResponseEntity<String> responseEntity = this.makeRequest(requestEntity);
            HTTPResponse httpResponse = this.adaptToNimbusResponse(responseEntity);
            TokenIntrospectionResponse introspectionResponse = this.parseNimbusResponse(httpResponse); // active : true (ì—¬ì „íˆ ì‚¬ìš© ê°€ëŠ¥í•¨)
            TokenIntrospectionSuccessResponse introspectionSuccessResponse = this.castToNimbusSuccess(introspectionResponse); // Parsing
            if (!introspectionSuccessResponse.isActive()) { // isActiveê°€, falseë©´ 401 Error
                this.logger.trace("Did not validate token since it is inactive");
                throw new BadOpaqueTokenException("Provided token isn't active");
            } else {
                return this.convertClaimsSet(introspectionSuccessResponse);
            }
        }
}

private OAuth2AuthenticatedPrincipal convertClaimsSet(TokenIntrospectionSuccessResponse response) {
        Collection<GrantedAuthority> authorities = new ArrayList();
        Map<String, Object> claims = response.toJSONObject();
        Iterator var5;
        if (response.getAudience() != null) {
            List<String> audiences = new ArrayList();
            var5 = response.getAudience().iterator();

            while(var5.hasNext()) {
                Audience audience = (Audience)var5.next();
                audiences.add(audience.getValue());
            }

            claims.put("aud", Collections.unmodifiableList(audiences));
        }

        if (response.getClientID() != null) {
            claims.put("client_id", response.getClientID().getValue());
        }

        Instant iat;
        if (response.getExpirationTime() != null) {
            iat = response.getExpirationTime().toInstant();
            claims.put("exp", iat);
        }

        if (response.getIssueTime() != null) {
            iat = response.getIssueTime().toInstant();
            claims.put("iat", iat);
        }

        if (response.getIssuer() != null) {
            claims.put("iss", response.getIssuer().getValue());
        }

        if (response.getNotBeforeTime() != null) {
            claims.put("nbf", response.getNotBeforeTime().toInstant());
        }

        if (response.getScope() != null) {
            List<String> scopes = Collections.unmodifiableList(response.getScope().toStringList());
            claims.put("scope", scopes);
            var5 = scopes.iterator();

            while(var5.hasNext()) {
                String scope = (String)var5.next();
                authorities.add(new SimpleGrantedAuthority("SCOPE_" + scope));
            }
        }

        return new OAuth2IntrospectionAuthenticatedPrincipal(claims, authorities); // Spring MVCì—ì„œ ì°¸ì¡°í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ê°ì²´
}
```

  - OpaqueTokenAuthenticationProvider
```java
public Authentication authenticate(Authentication authentication) throws AuthenticationException {
        if (!(authentication instanceof BearerTokenAuthenticationToken)) {
            return null;
        } else {
            BearerTokenAuthenticationToken bearer = (BearerTokenAuthenticationToken)authentication;
            OAuth2AuthenticatedPrincipal principal = this.getOAuth2AuthenticatedPrincipal(bearer);
            AbstractAuthenticationToken result = this.convert(principal, bearer.getToken()); // convert
            result.setDetails(bearer.getDetails());
            this.logger.debug("Authenticated token");
            return result;
        }
}

private AbstractAuthenticationToken convert(OAuth2AuthenticatedPrincipal principal, String token) {
        Instant iat = (Instant)principal.getAttribute("iat");
        Instant exp = (Instant)principal.getAttribute("exp");
        OAuth2AccessToken accessToken = new OAuth2AccessToken(TokenType.BEARER, token, iat, exp);
        return new BearerTokenAuthentication(principal, accessToken, principal.getAuthorities()); // BearerTokenAuthentication : ìµœì¢… ì¸ì¦ ê°ì²´ (ì•ˆì— OAuth2IntrospectionAuthenticatedPrincipal ì¡´ì¬)
}
```

  - BearerTokenAuthenticationFilter
```java
protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        String token;
        try {
            token = this.bearerTokenResolver.resolve(request); // í† í°ì„ Parsingí•´ì„œ ì²˜ë¦¬ (ì¸ê°€ ì„œë²„ë¡œ ì „ì†¡í•˜ê¸° ìœ„í•¨)
        } catch (OAuth2AuthenticationException var10) {
            OAuth2AuthenticationException invalid = var10;
            this.logger.trace("Sending to authentication entry point since failed to resolve bearer token", invalid);
            this.authenticationEntryPoint.commence(request, response, invalid);
            return;
        }

        if (token == null) {
            this.logger.trace("Did not process request since did not find bearer token");
            filterChain.doFilter(request, response);
        } else {
            BearerTokenAuthenticationToken authenticationRequest = new BearerTokenAuthenticationToken(token); // ì¸ì¦ ì²˜ë¦¬ ì‹œì‘
            authenticationRequest.setDetails(this.authenticationDetailsSource.buildDetails(request));

            try {
                AuthenticationManager authenticationManager = this.authenticationManagerResolver.resolve(request); // AuthenticationManagerì—ê²Œ ì „ë‹¬ (OpaqueTokenAuthenticationProvider)
                Authentication authenticationResult = authenticationManager.authenticate(authenticationRequest); // ì¸ì¦ ì™„ë£Œ
                SecurityContext context = SecurityContextHolder.createEmptyContext();
                context.setAuthentication(authenticationResult);
                SecurityContextHolder.setContext(context);
                this.securityContextRepository.saveContext(context, request, response); // SecurityContextì— ì €ì¥
                if (this.logger.isDebugEnabled()) {
                    this.logger.debug(LogMessage.format("Set SecurityContextHolder to %s", authenticationResult));
                }

                filterChain.doFilter(request, response);
            } catch (AuthenticationException var9) {
                AuthenticationException failed = var9;
                SecurityContextHolder.clearContext();
                this.logger.trace("Failed to process authentication request", failed);
                this.authenticationFailureHandler.onAuthenticationFailure(request, response, failed);
            }

        }
}
```

5. ê²°ê³¼
```json
{
    "active": true,
    "authentication": {
        "authorities": [
            {
                "authority": "SCOPE_read"
            },
            {
                "authority": "SCOPE_openid"
            },
            {
                "authority": "SCOPE_write"
            }
        ],

...

}
```
