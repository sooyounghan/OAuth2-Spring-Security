-----
### íŒŒì¼ êµ¬ì„±
-----
<div align="center">
<img src="https://github.com/user-attachments/assets/58a8a8d3-87ca-44da-8f2f-6f3f58b27d95">
</div>

1. ê° OAuth2 ì„œë¹„ìŠ¤ ì œê³µìë“¤ì˜ ì—°ë™ì„ í†µí•´ ì¸ì¦ ë° ì¸ê°€ ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ê³  ê³µí†µ í•­ëª©ì€ ì¶”ìƒí™”
2. OpenID Connect Providerë¥¼ ì§€ì›í•˜ëŠ” ì„œë²„ì™€ ì§€ì›í•˜ì§€ ì•ŠëŠ” ì„œë²„ì— ëŒ€í•˜ì—¬ ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ì—°ë™ ì²˜ë¦¬ë¥¼ ìœ„í•œ ë‚´ë¶€ ì›ë¦¬ ì´í•´
3. OAuth2UserServiceë¥¼ ì»¤ìŠ¤í…€ë§ˆì´ì§•í•˜ì—¬ ì¸ì¦ ì´í›„ íšŒì› ê°€ì… ì²˜ë¦¬ë¥¼ ìœ„í•œ ë¶€ê°€ ì„œë¹„ìŠ¤ êµ¬í˜„
4. OAuth2Userì™€ OidcUser ì²˜ë¦¬ë¥¼ êµ¬ë¶„í•˜ì—¬ êµ¬í˜„, ìŠ¤í”„ë§ MVCì—ì„œ íƒ€ì…ë³„ë¡œ ì¸ì¦ ê°ì²´ë¥¼ ì°¸ì¡°í•˜ëŠ” ë°©ë²• í™•ì¸
5. Scopeì˜ ì •ë³´ë¥¼ ê¶Œí•œ ì •ë³´ë¡œ ë§¤í•‘í•˜ëŠ” ì›ë¦¬ íŒŒì•…, ì´ë¥¼ ì»¤ìŠ¤í…€ ë§ˆì´ì§•

-----
### Google ì—°ë™ ì ˆì°¨
-----
1. OAuth2 Clientì™€ Google ì¸ê°€ ì„œë²„ì™€ì˜ ì—°ë™ì„ í†µí•´ ì¸ì¦ / ì¸ê°€ í”„ë¡œì„¸ìŠ¤ êµ¬í˜„
2. êµ¬ê¸€ ì„œë¹„ìŠ¤ì— ì‹ ê·œ ì„œë¹„ìŠ¤ ìƒì„± : ```https://console.cloud.google.com```
  - í”„ë¡œì íŠ¸ ì„ íƒ - ìƒˆ í”„ë¡œì íŠ¸ - í”„ë¡œì íŠ¸ ì´ë¦„ (google-client-app) ìƒì„±
  - ë©”ë‰´ì˜ API ì„œë¹„ìŠ¤ - OAuth ë™ì˜ í™”ë©´ - ì•± ì´ë¦„ (my-google-client-app), ì‚¬ìš©ì ì§€ì› ì´ë©”ì¼ / ëŒ€ìƒ : ì™¸ë¶€ / ì—°ë½ì²˜ ì •ë³´
  - ë²”ìœ„ ì„¤ì • : ë°ì´í„° ì•¡ì„¸ìŠ¤ - ë²”ìœ„ ì¶”ê°€ ë˜ëŠ” ì‚­ì œ - .../auth/userinfo.email, .../auth/userinfo.profile, openid ì„ íƒ
  - í´ë¼ì´ì–¸íŠ¸ - ì‚¬ìš©ì ì¸ì¦ ì •ë³´ ë§Œë“¤ê¸° - OAuth í´ë¼ì´ì–¸íŠ¸ ID - ìœ í˜• : ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜, ìŠ¹ì¸ëœ ë¦¬ë‹¤ì´ë ‰ì…˜ URI (```http://localhost:8081/login/oauth2/code/google```)
  - í´ë¼ì´ì–¸íŠ¸ IDì™€ í´ë¼ì´ì–¸íŠ¸ ë³´ì•ˆ ë¹„ë°€ë²ˆí˜¸ ìƒì„±

3. application.yml ì„¤ì •
<div align="center">
<img src="https://github.com/user-attachments/assets/aac02745-03d6-4ce6-8451-cc210097df25">
</div>

  - client_id, client_secret í•„ìš”

-----
### Naver ì—°ë™ ì ˆì°¨
-----
1. OAuth2 Clientì™€ Naver ì¸ê°€ ì„œë²„ì™€ì˜ ì—°ë™ì„ í†µí•´ ì¸ì¦ / ì¸ê°€ í”„ë¡œì„¸ìŠ¤ êµ¬í˜„
2. ë„¤ì´ë²„ APIì— ì‹ ê·œ ì„œë¹„ìŠ¤ ìƒì„± : ```https://developers.naver.com/main/```
  - ì• í”Œë¦¬ì¼€ì´ì…˜ ë“±ë¡ - ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ë¦„ (naver-client-app2) / ì‚¬ìš© API : ë„¤ì´ë²„ ë¡œê·¸ì¸ (íšŒì› ì´ë¦„, ì—°ë½ì²˜ ì´ë©”ì¼ ì£¼ì†Œ, í”„ë¡œí•„ ì‚¬ì§„ í•„ìˆ˜)
  - ì„œë¹„ìŠ¤ URL : http://localhost:8081
  - ë¡œê·¸ì¸ ì˜¤í”ˆ API ì„œë¹„ìŠ¤ í™˜ê²½ (PC ì›¹)ì—ì„œ ë„¤ì´ë²„ ë¡œê·¸ì¸ Callback URL (```http://localhost:8081/login/oauth2/code/naver```)
  - í´ë¼ì´ì–¸íŠ¸ IDì™€ í´ë¼ì´ì–¸íŠ¸ Secret ìƒì„±

3. application.yml ì„¤ì •
<div align="center">
<img src="https://github.com/user-attachments/assets/d95e44b2-5d41-47d2-ad46-6ab444cc0348">
</div>

  - NaverëŠ” ê¸°ë³¸ ì„¤ì •ì„ ì œê³µí•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, registration, provider ì •ë³´ í•„ìš”

-----
### Keycloak ì—°ë™ ì ˆì°¨
-----
1. OAuth2 Clientì™€ Keycloak ì¸ê°€ ì„œë²„ì™€ì˜ ì—°ë™ì„ í†µí•´ ì¸ì¦ / ì¸ê°€ í”„ë¡œì„¸ìŠ¤ êµ¬í˜„
2. ```https://localhost:8080```
3. application.yml ì„¤ì •
<div align="center">
<img src="https://github.com/user-attachments/assets/3649e7b3-1833-47b9-9629-901d733bef0a">
</div>

-----
### ê¸°ë³¸ ì„¤ì •
-----
1. index.html
```html
<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/static/css/owl.carousel.min.css">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/static/css/bootstrap.min.css">

  <!-- Style -->
  <link rel="stylesheet" href="/static/css/style.css">

  <title>Login</title>
</head>
<body>
<div class="content">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-5" sec:authorize="isAnonymous()">
        <div class="social-login text-center">
          <a th:href="@{/oauth2/authorization/google}" class="google btn btn-block">
            <span>Sign in with Google</span>
          </a>
          <a th:href="@{/oauth2/authorization/naver}" class="naver btn btn-block">
            <span>Sign in with Naver</span>
          </a>
          <a th:href="@{/oauth2/authorization/keycloak}" class="keycloak btn btn-block">
            <span>Sign in with Keycloak</span>
          </a>
        </div>
      </div>
      <div class="col-md-5">
        <div class="social-login text-center">
          <div sec:authorize="isAuthenticated()">
            <div><h2>ì•ˆë…•í•˜ì„¸ìš” <span th:text="${user}"/> ë‹˜</h2></div>
            </br></br>
            <a th:href="@{/api/user}" class="keycloak btn btn-block">OAuth2 ì¸ì¦ ì •ë³´</a>
            <a th:href="@{/api/oidc}" class="keycloak btn btn-block">OpenID Connect ì¸ì¦ ì •ë³´</a></br></br>
            <a th:href="@{/logout}" class="google btn btn-block">Logout</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="/static/js/jquery-3.3.1.min.js"></script>
<script src="/static/js/popper.min.js"></script>
<script src="/static/js/bootstrap.min.js"></script>
<script src="/static/js/main.js"></script>
</body>
</html>
```

2. HomeController
```java
package io.security.oauth2.springsecurityoauth2.controller;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;

@Controller
public class HomeController {
    @GetMapping("/home")
    public String home() {
        return "home";
    }
}
```

3. IndexController
```java
package io.security.oauth2.springsecurityoauth2.controller;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;

@Controller
public class IndexController {

    @GetMapping("/")
    public String index() {
        return "index";
    }
}
```

4. OAuth2ClientConfig
```java
package io.security.oauth2.springsecurityoauth2;

import org.springframework.context.annotation.Bean;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityCustomizer;
import org.springframework.security.web.SecurityFilterChain;

@EnableWebSecurity
public class OAuth2ClientConfig {

    @Bean
    public WebSecurityCustomizer webSecurityCustomizer() {
        return (web) -> web.ignoring().antMatchers("/static/js/**", "/static/images/**", "/static/css/**", "/static/scss/**");
    }
    
    @Bean
    SecurityFilterChain oauth2ClientSecurityFilterChain(HttpSecurity http) throws Exception {
        http.authorizeRequests(authRequest -> authRequest
                .antMatchers("/").permitAll()
                .anyRequest().authenticated());

        http.oauth2Login(Customizer.withDefaults());

        http.logout().logoutSuccessUrl("/");

        return http.build();
    }
}
```

-----
### Model
-----
1. ProviderUser (Interface)
```java
package io.security.oauth2.springsecurityoauth2.model;

import org.springframework.security.core.GrantedAuthority;

import java.util.List;
import java.util.Map;

public interface ProviderUser {

    String getId();

    String getUsername();

    String getPassword();

    String getEmail();

    String getProvider();

    List<? extends GrantedAuthority> getAuthorities();

    Map<String, Object> getAttributes();
}
```

2. OAuth2ProviderUser
```java
package io.security.oauth2.springsecurityoauth2.model;

import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.oauth2.client.registration.ClientRegistration;
import org.springframework.security.oauth2.core.user.OAuth2User;

import java.util.List;
import java.util.Map;
import java.util.UUID;
import java.util.stream.Collectors;

public abstract class OAuth2ProviderUser implements ProviderUser {

    private OAuth2User oAuth2User;
    private ClientRegistration clientRegistration;
    private Map<String, Object> attributes;

    public OAuth2ProviderUser(OAuth2User oAuth2User, Map<String, Object> attributes, ClientRegistration clientRegistration) {
        this.oAuth2User = oAuth2User;
        this.attributes = attributes;
        this.clientRegistration = clientRegistration;
    }

    @Override
    public String getPassword() {
        return UUID.randomUUID().toString();
    }

    @Override
    public String getEmail() {
        return (String) getAttributes().get("email");
    }

    @Override
    public String getProvider() {
        return clientRegistration.getRegistrationId();
    }

    @Override
    public List<? extends GrantedAuthority> getAuthorities() {
        // Collection -> List Stream
        return oAuth2User.getAuthorities().stream().map(authority -> new SimpleGrantedAuthority(authority.getAuthority())).collect(Collectors.toList());
    }

    @Override
    public Map<String, Object> getAttributes() {
        return attributes;
    }
}
```

3. GoogleUser
```java
package io.security.oauth2.springsecurityoauth2.model;

import org.springframework.security.oauth2.client.registration.ClientRegistration;
import org.springframework.security.oauth2.core.user.OAuth2User;


public class GoogleUser extends OAuth2ProviderUser {

    public GoogleUser(OAuth2User oAuth2User, ClientRegistration clientRegistration) {
        super(oAuth2User, oAuth2User.getAttributes(), clientRegistration);
    }

    @Override
    public String getId() {
        return (String) getAttributes().get("sub");
    }

    @Override
    public String getUsername() {
        return (String) getAttributes().get("sub");
    }
}
```

4. NaverUser
```java
package io.security.oauth2.springsecurityoauth2.model;

import org.springframework.security.oauth2.client.registration.ClientRegistration;
import org.springframework.security.oauth2.core.user.OAuth2User;

import java.util.Map;

public class NaverUser extends OAuth2ProviderUser {

    public NaverUser(OAuth2User oAuth2User, ClientRegistration clientRegistration) {
        // Naverì˜ ê²½ìš° Response í•˜ìœ„ì— ê° Attribute ì¡´ì¬
        super(oAuth2User, (Map<String, Object>) oAuth2User.getAttributes().get("response"), clientRegistration);
    }

    @Override
    public String getId() {
        return (String) getAttributes().get("id");
    }

    @Override
    public String getUsername() {
        return (String) getAttributes().get("email");
    }
}
```

5. KeycloakUser
```java
package io.security.oauth2.springsecurityoauth2.model;

import org.springframework.security.oauth2.client.registration.ClientRegistration;
import org.springframework.security.oauth2.core.user.OAuth2User;

public class KeycloakUser extends OAuth2ProviderUser {

    public KeycloakUser(OAuth2User oAuth2User, ClientRegistration clientRegistration) {
        super(oAuth2User, oAuth2User.getAttributes(), clientRegistration);
    }

    @Override
    public String getId() {
        return (String) getAttributes().get("sub");
    }

    @Override
    public String getUsername() {
        return (String) getAttributes().get("preferred_username");
    }
}
```

6. User (Builder)
```java
package io.security.oauth2.springsecurityoauth2.model;

import lombok.Builder;
import lombok.Data;
import org.springframework.security.core.GrantedAuthority;

import java.util.List;

@Data
@Builder
public class User {
    private String registrationId;
    private String id; // ì‹ë³„ì
    private String username;
    private String password;
    private String provider;
    private String email;
    private List<? extends GrantedAuthority> authorities;
}
```

-----
### Service
-----
1. UserRepository
```java
package io.security.oauth2.springsecurityoauth2.repository;

import io.security.oauth2.springsecurityoauth2.model.User;
import org.springframework.stereotype.Repository;

import java.util.HashMap;
import java.util.Map;

@Repository
public class UserRepository {
    private Map<String, Object> users = new HashMap<>(); // DB ì‚¬ìš©ì´ ì•„ë‹ˆë¯€ë¡œ Map ì‚¬ìš©

    public User findByUsername(String username) {
        if(users.containsKey(username)) {
            return (User) users.get(username);
        }

        return null;
    }

    public void register(User user) {
        if(users.containsKey(user.getUsername())) {
            return; // ìˆìœ¼ë©´, return
        }

        users.put(user.getUsername(), user); // ì—†ìœ¼ë©´ ì¶”ê°€
    }
}
```

2. UserService
```java
package io.security.oauth2.springsecurityoauth2.service;

import io.security.oauth2.springsecurityoauth2.model.ProviderUser;
import io.security.oauth2.springsecurityoauth2.model.User;
import io.security.oauth2.springsecurityoauth2.repository.UserRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class UserService {

    @Autowired
    private UserRepository userRepository;

    public void register(String registrationId, ProviderUser providerUser) {
        // User í´ë˜ìŠ¤ ë¹Œë“œ
        User user = User.builder()
                .registrationId(registrationId)
                .id(providerUser.getId())
                .username(providerUser.getUsername())
                .provider(providerUser.getPassword())
                .email(providerUser.getEmail())
                .authorities(providerUser.getAuthorities())
                .build();

        userRepository.register(user);
    }
}
```

3. AbstractOAuth2UserService
```java
package io.security.oauth2.springsecurityoauth2.service;

import io.security.oauth2.springsecurityoauth2.model.*;
import io.security.oauth2.springsecurityoauth2.repository.UserRepository;
import lombok.Getter;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.oauth2.client.registration.ClientRegistration;
import org.springframework.security.oauth2.client.userinfo.OAuth2UserRequest;
import org.springframework.security.oauth2.core.user.OAuth2User;
import org.springframework.stereotype.Service;

@Service
@Getter
public abstract class AbstractOAuth2UserService {

    @Autowired
    public UserRepository userRepository;

    @Autowired
    public UserService userService;

    public ProviderUser providerUser(ClientRegistration clientRegistration, OAuth2User oAuth2User) {
        // RegistrationIdë¡œ êµ¬ë¶„
        String registrationId = clientRegistration.getRegistrationId();

        if(registrationId.equals("keycloak")) {

            return new KeycloakUser(oAuth2User, clientRegistration);

        } else if(registrationId.equals("google")) {

            return new GoogleUser(oAuth2User, clientRegistration);

        } else if(registrationId.equals("naver")) {

            return new NaverUser(oAuth2User, clientRegistration);

        }

        return null;
    }

    public void register(ProviderUser providerUser, OAuth2UserRequest userRequest) {
        User user = userRepository.findByUsername(providerUser.getUsername());

        if(user == null) {
            String registrationId = userRequest.getClientRegistration().getRegistrationId();

            userService.register(registrationId, providerUser);
        } else {
            System.out.println("user = " + user);
        }
    }
}
```

4. CustomOAuth2UserService
```java
package io.security.oauth2.springsecurityoauth2.service;

import io.security.oauth2.springsecurityoauth2.model.ProviderUser;
import org.springframework.security.oauth2.client.registration.ClientRegistration;
import org.springframework.security.oauth2.client.userinfo.DefaultOAuth2UserService;
import org.springframework.security.oauth2.client.userinfo.OAuth2UserRequest;
import org.springframework.security.oauth2.client.userinfo.OAuth2UserService;
import org.springframework.security.oauth2.core.OAuth2AuthenticationException;
import org.springframework.security.oauth2.core.user.OAuth2User;
import org.springframework.stereotype.Service;

@Service
public class CustomOAuth2UserService extends AbstractOAuth2UserService implements OAuth2UserService<OAuth2UserRequest, OAuth2User> {

    @Override
    public OAuth2User loadUser(OAuth2UserRequest userRequest) throws OAuth2AuthenticationException {

        ClientRegistration clientRegistration = userRequest.getClientRegistration();

        OAuth2UserService<OAuth2UserRequest, OAuth2User> oAuth2UserService = new DefaultOAuth2UserService();
        OAuth2User oAuth2User = oAuth2UserService.loadUser(userRequest); // ì¸ì¦ ê³¼ì •

        ProviderUser providerUser = super.providerUser(clientRegistration, oAuth2User);

        // íšŒì› ê°€ì…
        super.register(providerUser, userRequest);

        return oAuth2User;
    }
}
```

5. CustomOidcUserService
```java
package io.security.oauth2.springsecurityoauth2.service;

import io.security.oauth2.springsecurityoauth2.model.ProviderUser;
import org.springframework.security.oauth2.client.oidc.userinfo.OidcUserRequest;
import org.springframework.security.oauth2.client.oidc.userinfo.OidcUserService;
import org.springframework.security.oauth2.client.registration.ClientRegistration;
import org.springframework.security.oauth2.client.userinfo.OAuth2UserService;
import org.springframework.security.oauth2.core.OAuth2AuthenticationException;
import org.springframework.security.oauth2.core.oidc.user.OidcUser;

@Service
public class CustomOidcUserService extends AbstractOAuth2UserService implements OAuth2UserService<OidcUserRequest, OidcUser> {
    @Override
    public OidcUser loadUser(OidcUserRequest userRequest) throws OAuth2AuthenticationException {
        ClientRegistration clientRegistration = userRequest.getClientRegistration();

        OAuth2UserService<OidcUserRequest, OidcUser> oidcUserService = new OidcUserService();
        OidcUser oidcUser = oidcUserService.loadUser(userRequest); // ì¸ì¦ ê³¼ì •

        ProviderUser providerUser = super.providerUser(clientRegistration, oidcUser);

        // íšŒì› ê°€ì…
        super.register(providerUser, userRequest);

        return oidcUser;
    }
}
```

-----
### application.yml
-----
```yml
server:
  port: 8081

spring:
  security:
    oauth2:
      client: ## prefix
        registration: ## í´ë¼ì´ì–¸íŠ¸ ì„¤ì • (Map ì†ì„±)
          keycloak: ## (Mapì˜ í‚¤ ê°’)
            authorizationGrantType: authorization_code
            clientId: oauth2-client-app
            clientName: oauth2-client-app
            clientSecret: zxMvv3yCjZVoEJFAUzNUdYlJgJla9yuf
            clientAuthenticationMethod: client_secret_basic
            redirectUri: http://localhost:8081/login/oauth2/code/keycloak
            scope: openid, profile

          google:
            client-id: 297586071592-qld2a4k62eucouleq2edokab0f7s7gn9.apps.googleusercontent.com
            client-secret: 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
            scope: profile, email
            #scope: openid, profile, email

          naver:
            authorization-grant-type: authorization_code
            client-id: DgOv9nXsx8v1oWQfw6Jy
            client-secret: J_F8G72aH9
            client-name: naver-client-app2
            redirect-uri: http://localhost:8081/login/oauth2/code/naver
            scope: profile, email

        provider: ## : ê³µê¸‰ì ì„¤ì • (Map ì†ì„±)
            keycloak: ## (Mapì˜ í‚¤ ê°’)
              authorizationUri: http://localhost:8080/realms/oauth2/protocol/openid-connect/auth
              issuerUri: http://localhost:8080/realms/oauth2
              jwkSetUri: http://localhost:8080/realms/oauth2/protocol/openid-connect/certs
              tokenUri: http://localhost:8080/realms/oauth2/protocol/openid-connect/token
              userInfoUri: http://localhost:8080/realms/oauth2/protocol/openid-connect/userinfo
              userNameAttribute: preferred_username
 
            naver: #ë„¤ì´ë²„ì˜ ê²½ìš°, ì™¸ë¶€ ì„œë¹„ìŠ¤ ì´ìš©ìì´ë¯€ë¡œ ì„¤ì • í•„ìš”
              authorization-uri: https://nid.naver.com/oauth2.0/authorize
              token-uri: https://nid.naver.com/oauth2.0/token
              user-info-uri: https://openapi.naver.com/v1/nid/me
              user-name-attribute: response

  mvc:
    static-path-pattern: "/static/**" ## ì •ì  ë¦¬ì†ŒìŠ¤ ë§¤í•‘ íŒ¨í„´ (ê¸°ë³¸ : ë£¨íŠ¸(/**)) ë³€ê²½
```

  - ë„¤ì´ë²„ ì—”ë“œí¬ì¸íŠ¸ ì •ë³´ í™•ì¸ : ê°œë°œ ê°€ì´ë“œ (```https://developers.naver.com/docs/login/devguide/devguide.md#3-4-2-%EB%84%A4%EC%9D%B4%EB%B2%84-%EB%A1%9C%EA%B7%B8%EC%9D%B8-%EC%97%B0%EB%8F%99-url-%EC%83%9D%EC%84%B1%ED%95%98%EA%B8%B0```)
  - ğŸ’¡ ì •ì  ë¦¬ì†ŒìŠ¤ ê¸°ë³¸ ìœ„ì¹˜ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë£¨íŠ¸(```/**```)ë¶€í„° ë§¤í•‘
    + classpath:/META-INF/resources/
    + classpath:/resources/
    + classpath:/static/
    + classpath:/public/
    + ê¸°ë³¸ ìœ„ì¹˜ ë³€ê²½ : spring.mvc.static-path-pattern: "/ë³€ê²½ìœ„ì¹˜"
      
-----
### ê¶Œí•œ ë§¤í•‘ / SecurityConfig / Contorller
-----
1. OAuth2ClientConfig
```java
package io.security.oauth2.springsecurityoauth2;

import io.security.oauth2.springsecurityoauth2.service.CustomOAuth2UserService;
import io.security.oauth2.springsecurityoauth2.service.CustomOidcUserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityCustomizer;
import org.springframework.security.core.authority.mapping.GrantedAuthoritiesMapper;
import org.springframework.security.web.SecurityFilterChain;

@EnableWebSecurity
public class OAuth2ClientConfig {
    @Autowired
    private CustomOAuth2UserService customOAuth2UserService;

    @Autowired
    private CustomOidcUserService customOidcUserService;

    @Bean
    public WebSecurityCustomizer webSecurityCustomizer() {
        return (web) -> web.ignoring().antMatchers("/static/js/**", "/static/images/**", "/static/css/**", "/static/scss/**");
    }

    @Bean
    SecurityFilterChain oauth2ClientSecurityFilterChain(HttpSecurity http, CustomOAuth2UserService customOAuth2UserService) throws Exception {
        http.authorizeRequests(authRequest -> authRequest
                .antMatchers("/api/user").access("hasAnyRole('SCOPE_profile', 'SCOPE_email')") // api ìì›ì— ì ‘ê·¼ ê°€ëŠ¥ (SCOPE_ ê¶Œí•œ)
                .antMatchers("/api/oidc").access("hasAnyRole('SCOPE_openid')") // OIDCì˜ ê²½ìš°ì—ëŠ” openid í¬í•¨
                .antMatchers("/").permitAll()
                .anyRequest().authenticated());

        http.oauth2Login(oauth2 -> oauth2.userInfoEndpoint(userInfoEndpointConfig // UserInfo EndPoint ì„¤ì •
                -> userInfoEndpointConfig.userService(customOAuth2UserService) // customOAuth2UserService
                                         .oidcUserService(customOidcUserService))); // customOidcUserService

        http.logout().logoutSuccessUrl("/");

        return http.build();
    }

    @Bean
    public GrantedAuthoritiesMapper customAuthorityMapper() {
        return new CustomAuthorityMapper();
    }
}
```

2. CustomAuthorityMapper
```java
package io.security.oauth2.springsecurityoauth2;

import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.authority.mapping.GrantedAuthoritiesMapper;

import java.util.Collection;
import java.util.HashSet;

public class CustomAuthorityMapper implements GrantedAuthoritiesMapper {
    // êµ¬ê¸€ì˜ ê²½ìš° http://..... ì—ì„œ ì˜¤ë¯€ë¡œ ì´ë¥¼ Split ì‘ì—… í•„ìš”

    private String prefix = "ROLE_"; // ê¸°ë³¸ PREFIX

    @Override
    public Collection<? extends GrantedAuthority> mapAuthorities(Collection<? extends GrantedAuthority> authorities) {

        HashSet<GrantedAuthority> mapped = new HashSet<>(authorities.size());

        for (GrantedAuthority authority : authorities) {
            mapped.add(mapAuthority(authority.getAuthority()));
        }

        return mapped;
    }

    private GrantedAuthority mapAuthority(String name) { // êµ¬ê¸€ ì˜ˆ) http://google.com/.../dd.email...
        if(name.lastIndexOf(".") > 0) { // ë§¨ ë§ˆì§€ë§‰ì— . ì´ ìˆë‹¤ë©´,
            int index = name.lastIndexOf(".");

            name = "SCOPE_" + name.substring(index + 1); // ë§ˆì§€ë§‰ . ì´í›„ì˜ ê°’ ì¶”ì¶œí›„, SCOPE_ ì´ë¦„ì„ ë¶™ì„
        }

        if(prefix.length() > 0 && !name.startsWith(prefix)) { // prefixê°€ ìˆê³ , prefixë¡œ ì‹œì‘í•˜ëŠ” ë¬¸ìê°€ ì—†ìœ¼ë©´,
            name = prefix + name; // prefixë¥¼ ë¶™ì—¬ ì‚¬ìš©
        }

        return new SimpleGrantedAuthority(name); // ì´ë¥¼ ê¶Œí•œ ë¶€ì—¬
    }
}
```


3. IndexController
```java
package io.security.oauth2.springsecurityoauth2.controller;

import org.springframework.security.core.Authentication;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.oauth2.client.authentication.OAuth2AuthenticationToken;
import org.springframework.security.oauth2.core.user.OAuth2User;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;

import java.util.Map;

@Controller
public class IndexController {

    @GetMapping("/")
    public String index(Model model, Authentication authentication, @AuthenticationPrincipal OAuth2User oAuth2User) {

        OAuth2AuthenticationToken oAuth2AuthenticationToken = (OAuth2AuthenticationToken) authentication;

        if(oAuth2AuthenticationToken != null) {
            Map<String, Object> attributes = oAuth2User.getAttributes();

            String userName = (String) attributes.get("name");

            // naverì˜ ê²½ìš° response ì˜ˆí•˜ì— ì¡´ì¬í•˜ë¯€ë¡œ ì´ë¥¼ Split
            if(oAuth2AuthenticationToken.getAuthorizedClientRegistrationId().equals("naver")) {
                Map<String, Object> response = (Map<String, Object>) attributes.get("response");

                userName = (String) response.get("name");
            }

            model.addAttribute("user", userName);
        }

        return "index";
    }
}
```

4. HomeController
```java
package io.security.oauth2.springsecurityoauth2.controller;

import org.springframework.security.core.Authentication;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.oauth2.core.oidc.user.OidcUser;
import org.springframework.security.oauth2.core.user.OAuth2User;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class HomeController {

    // ì¸ì¦ ì™„ë£Œ ìƒíƒœ (SCOPE_profie, SCOPE_email ê¶Œí•œ í•„ìš”) [OIDC ì§€ì›ì´ ë˜ì§€ ì•Šì€ ê²½ìš°]
    @GetMapping("/api/user")
    public Authentication user(Authentication authentication, @AuthenticationPrincipal OAuth2User oAuth2User) {

        System.out.println("authentication = " + authentication + "oAuth2User = " + oAuth2User);

        return authentication;
    }

    // ì¸ì¦ ì™„ë£Œ ìƒíƒœ (OIDC ì´ë¯€ë¡œ SCOPE_openid í•„ìš”) [êµ¬ê¸€ì˜ ê²½ìš° OIDC ì§€ì›í•˜ë¯€ë¡œ ì´ ê¶Œí•œì„ ê°€ëŠ¥í•˜ë„ë¡ í•˜ê¸° ìœ„í•¨]
    @GetMapping("/api/oidc")
    public Authentication oidc(Authentication authentication, @AuthenticationPrincipal OidcUser oidcUser) {

        System.out.println("authentication = " + authentication + "oidcUser = " + oidcUser);

        return authentication;
    }
}
```

5. ê²°ê³¼
   - êµ¬ê¸€
<div align="center">
<img src="https://github.com/user-attachments/assets/00498bfd-60f2-45f0-aa6c-93717283e027">
<img src="https://github.com/user-attachments/assets/f0120286-cded-4fd4-831c-6ebc85925402">
</div>

  - ë„¤ì´ë²„ (openid ê¶Œí•œ ì—†ìŒ)
<div align="center">
<img src="https://github.com/user-attachments/assets/fd344018-d7e2-460a-b22f-74515f9dba62">
</div>




