-----
### ê°œìš”
-----
1. ì£¼ìš” í´ë˜ìŠ¤
   - OAuth2AuthorizationRequestRedirectFilter : í´ë¼ì´ì–¸íŠ¸ëŠ” ì‚¬ìš©ìì˜ ë¸Œë¼ìš°ì €ë¥¼ í†µí•´ ì¸ê°€ ì„œë²„ì˜ ê¶Œí•œ ë¶€ì—¬ ì—”ë“œí¬ì¸íŠ¸ë¡œ Redirectioní•˜ì—¬ ê¶Œí•œ ì½”ë“œ ë¶€ì—¬ íë¦„ì„ ì‹œì‘

<div align="center">
<img src="https://github.com/user-attachments/assets/1f74d0bd-698a-46cd-9a61-cd5c75a739d0">
</div>

2. ìš”ì²­ ë§¤í•‘ URL
   - AuthorizationRequestMatcher : /oauth2/authorization/{registrationId}
   - AuthorizationEndPointConfig.authorizationRequestBaseUri()ë¥¼ í†µí•´ ì¬ì •ì˜ ê°€ëŠ¥

3. DefaultOAuth2AuthorizationRequestResolver
   - ì›¹ ìš”ì²­ì— ëŒ€í•´ OAuth2AuthorizationRequest ê°ì²´ë¥¼ ìµœì¢… ì™„ì„±
   - /oauth2/authorization/{registrationId} ì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•´ì„œ ì¼ì¹˜í•˜ë©´, regsitrationIdë¥¼ ì¶”ì¶œí•˜ê³ , ì´ë¥¼ ì‚¬ìš©í•´ì„œ ClientRegistrationë¥¼ ê°€ì ¸ì™€ OAuth2AuthorizationRequestë¥¼ ë¹Œë“œ

<div align="center">
<img src="https://github.com/user-attachments/assets/cd0aa5f4-bfb4-427e-8265-67dec7310626">
</div>

4. OAuth2AuthorizationRequest : í† í° ì—”ë“œí¬ì¸íŠ¸ ìš”ì²­ íŒŒë¼ë¯¸í„°ë¥¼ ë‹´ì€ ê°ì²´ë¡œì„œ, ì¸ê°€ ì‘ë‹µì„ ì—°ê³„í•˜ê³  ê²€ì¦í•  ë•Œ ì‚¬ìš©

<div align="center">
<img src="https://github.com/user-attachments/assets/aee86445-8efd-4b1a-be14-4bfa2ff7ff55">
</div>

5. OAuth2AuthorizationRequestRepository : ì¸ê°€ ìš”ì²­ì„ ì‹œì‘í•œ ì‹œì ë¶€í„° ì¸ê°€ ìš”ì²­ì„ ë°›ëŠ” ì‹œì ê¹Œì§€ (Redirect) OAuth2AuthorizationRequestë¥¼ ìœ ì§€

-----
### ğŸ’¡ CODEë¥¼ ë°›ì•„ì˜¤ê³  Redirect ë˜ëŠ” ê³¼ì •
-----
<div align="center">
<img src="https://github.com/user-attachments/assets/a066eec6-dbae-48a9-8d78-48850d777230">
</div>

  - FilterSecurityInterceptor : ê¶Œí•œ ê´€ë¦¬ë¥¼ í™•ì¸í•˜ëŠ” ë§ˆì§€ë§‰ í•„í„° (í™•ì¸ë˜ì§€ ì•Šìœ¼ë©´, ExceptionTranslationFilterë¡œ ì´ë™)

-----
### ì½”ë“œ
-----
1. /oauth2/authorizationë¡œ ì ‘ê·¼
  - OAuth2AuthorizationRequestRedirectFilter  
```java
public static final String DEFAULT_AUTHORIZATION_REQUEST_BASE_URI = "/oauth2/authorization";
private OAuth2AuthorizationRequestResolver authorizationRequestResolver;

protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        Exception ex;
        try {
            OAuth2AuthorizationRequest authorizationRequest = this.authorizationRequestResolver.resolve(request);
            if (authorizationRequest != null) {
                this.sendRedirectForAuthorization(request, response, authorizationRequest);
                return;
            }
        } catch (Exception var11) {
            ex = var11;
            this.unsuccessfulRedirectForAuthorization(request, response, ex);
            return;
        }

        try {
            filterChain.doFilter(request, response);
        } catch (IOException var9) {
            IOException ex = var9;
            throw ex;
        } catch (Exception var10) {
            ex = var10;
            Throwable[] causeChain = this.throwableAnalyzer.determineCauseChain(ex);
            ClientAuthorizationRequiredException authzEx = (ClientAuthorizationRequiredException)this.throwableAnalyzer.getFirstThrowableOfType(ClientAuthorizationRequiredException.class, causeChain);
            if (authzEx != null) {
                try {
                    OAuth2AuthorizationRequest authorizationRequest = this.authorizationRequestResolver.resolve(request, authzEx.getClientRegistrationId()); // OAuth2AuthorizationRequest ìƒì„±
                    if (authorizationRequest == null) {
                        throw authzEx;
                    }

                    this.sendRedirectForAuthorization(request, response, authorizationRequest); // ì¸ê°€ ì„œë²„ë¡œ ì „ì†¡
                    this.requestCache.saveRequest(request, response);
                } catch (Exception var8) {
                    Exception failed = var8;
                    this.unsuccessfulRedirectForAuthorization(request, response, failed);
                }

            } else if (ex instanceof ServletException) {
                throw (ServletException)ex;
            } else if (ex instanceof RuntimeException) {
                throw (RuntimeException)ex;
            } else {
                throw new RuntimeException(ex);
            }
        }
}

private void sendRedirectForAuthorization(HttpServletRequest request, HttpServletResponse response, OAuth2AuthorizationRequest authorizationRequest) throws IOException {
        if (AuthorizationGrantType.AUTHORIZATION_CODE.equals(authorizationRequest.getGrantType())) {
            this.authorizationRequestRepository.saveAuthorizationRequest(authorizationRequest, request, response); // HttpSessionOAuth2AuthorizationRequestRepositoryì— ì €ì¥
        }

        this.authorizationRedirectStrategy.sendRedirect(request, response, authorizationRequest.getAuthorizationRequestUri());
}
```

  - DefaultOAuth2AuthorizationRequestResolver
```java
public OAuth2AuthorizationRequest resolve(HttpServletRequest request) {
        String registrationId = this.resolveRegistrationId(request); // registrationIdë¥¼ ì½ì–´ì˜´
        if (registrationId == null) {
            return null;
        } else {
            String redirectUriAction = this.getAction(request, "login"); // Get ACTION ("/login")ìœ¼ë¡œ ì¹˜í™˜
            return this.resolve(request, registrationId, redirectUriAction);
        }
}

private String resolveRegistrationId(HttpServletRequest request) {
        return this.authorizationRequestMatcher.matches(request) ? (String)this.authorizationRequestMatcher.matcher(request).getVariables().get("registrationId") : null;
}

private OAuth2AuthorizationRequest resolve(HttpServletRequest request, String registrationId, String redirectUriAction) {
        if (registrationId == null) {
            return null;
        } else {
            ClientRegistration clientRegistration = this.clientRegistrationRepository.findByRegistrationId(registrationId); // regsitrationIdë¥¼ í†µí•´ ClientRegistrationRepositoryì—ì„œ ClientRegistration ê°€ì ¸ì˜´
            if (clientRegistration == null) {
                throw new IllegalArgumentException("Invalid Client Registration with Id: " + registrationId);
            } else {
                OAuth2AuthorizationRequest.Builder builder = this.getBuilder(clientRegistration); // OAuth2AuthorizationRequest ë¹Œë”ë¥¼ ê°€ì ¸ì˜´
                String redirectUriStr = expandRedirectUri(request, clientRegistration, redirectUriAction); // Redirect URI ìƒì„±
                builder.clientId(clientRegistration.getClientId()).authorizationUri(clientRegistration.getProviderDetails().getAuthorizationUri()).redirectUri(redirectUriStr).scopes(clientRegistration.getScopes()).state(DEFAULT_STATE_GENERATOR.generateKey());
                this.authorizationRequestCustomizer.accept(builder);
                return builder.build(); // build
            }
        }
}

private OAuth2AuthorizationRequest.Builder getBuilder(ClientRegistration clientRegistration) {
        if (AuthorizationGrantType.AUTHORIZATION_CODE.equals(clientRegistration.getAuthorizationGrantType())) { // AUTHORIZATION_CODE ë°©ì‹
            OAuth2AuthorizationRequest.Builder builder = OAuth2AuthorizationRequest.authorizationCode().attributes((attrs) -> { // ë¹Œë” í´ë˜ìŠ¤ ìƒì„± ë° registrationId ì €ì¥
                attrs.put("registration_id", clientRegistration.getRegistrationId());
            });
            if (!CollectionUtils.isEmpty(clientRegistration.getScopes()) && clientRegistration.getScopes().contains("openid")) { // scope ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë°, openidê°€ í¬í•¨ë˜ì—ˆë‹¤ë©´, applyNonce ë§¤ê°œë³€ìˆ˜ ì¶”ê°€
                applyNonce(builder);
            }

            if (ClientAuthenticationMethod.NONE.equals(clientRegistration.getClientAuthenticationMethod())) { // ClientAuthenticationMethodê°€ NONEì´ë©´ PKCE ë°©ì‹ ì‚¬ìš©
                DEFAULT_PKCE_APPLIER.accept(builder);
            }

            return builder;
        } else if (AuthorizationGrantType.IMPLICIT.equals(clientRegistration.getAuthorizationGrantType())) {
            return OAuth2AuthorizationRequest.implicit();
        } else {
            throw new IllegalArgumentException("Invalid Authorization Grant Type (" + clientRegistration.getAuthorizationGrantType().getValue() + ") for Client Registration with Id: " + clientRegistration.getRegistrationId());
        }
}

private static String expandRedirectUri(HttpServletRequest request, ClientRegistration clientRegistration, String action) {
        Map<String, String> uriVariables = new HashMap();
        uriVariables.put("registrationId", clientRegistration.getRegistrationId());
        UriComponents uriComponents = UriComponentsBuilder.fromHttpUrl(UrlUtils.buildFullRequestUrl(request)).replacePath(request.getContextPath()).replaceQuery((String)null).fragment((String)null).build();
        String scheme = uriComponents.getScheme();
        uriVariables.put("baseScheme", scheme != null ? scheme : "");
        String host = uriComponents.getHost();
        uriVariables.put("baseHost", host != null ? host : "");
        int port = uriComponents.getPort();
        uriVariables.put("basePort", port == -1 ? "" : ":" + port);
        String path = uriComponents.getPath();
        if (StringUtils.hasLength(path) && path.charAt(0) != '/') {
            path = '/' + path;
        }

        uriVariables.put("basePath", path != null ? path : "");
        uriVariables.put("baseUrl", uriComponents.toUriString());
        uriVariables.put("action", action != null ? action : "");
        return UriComponentsBuilder.fromUriString(clientRegistration.getRedirectUri()).buildAndExpand(uriVariables).toUriString();
}
```

  - OAuth2AuthorizationRequest
```java
public OAuth2AuthorizationRequest build() {
            Assert.hasText(this.authorizationUri, "authorizationUri cannot be empty");
            Assert.hasText(this.clientId, "clientId cannot be empty");
            if (AuthorizationGrantType.IMPLICIT.equals(this.authorizationGrantType)) {
                Assert.hasText(this.redirectUri, "redirectUri cannot be empty");
            }

            OAuth2AuthorizationRequest authorizationRequest = new OAuth2AuthorizationRequest();
            authorizationRequest.authorizationUri = this.authorizationUri;
            authorizationRequest.authorizationGrantType = this.authorizationGrantType;
            authorizationRequest.responseType = this.responseType;
            authorizationRequest.clientId = this.clientId;
            authorizationRequest.redirectUri = this.redirectUri;
            authorizationRequest.state = this.state;
            authorizationRequest.scopes = Collections.unmodifiableSet((Set)(CollectionUtils.isEmpty(this.scopes) ? Collections.emptySet() : new LinkedHashSet(this.scopes)));
            authorizationRequest.additionalParameters = Collections.unmodifiableMap(this.additionalParameters);
            authorizationRequest.attributes = Collections.unmodifiableMap(this.attributes);
            authorizationRequest.authorizationRequestUri = StringUtils.hasText(this.authorizationRequestUri) ? this.authorizationRequestUri : this.buildAuthorizationRequestUri();
            return authorizationRequest;
}
```

  - HttpSessionOAuth2AuthorizationRequestRepository
```java
public void saveAuthorizationRequest(OAuth2AuthorizationRequest authorizationRequest, HttpServletRequest request, HttpServletResponse response) {
        Assert.notNull(request, "request cannot be null");
        Assert.notNull(response, "response cannot be null");
        if (authorizationRequest == null) {
            this.removeAuthorizationRequest(request, response);
        } else {
            String state = authorizationRequest.getState();
            Assert.hasText(state, "authorizationRequest.state cannot be empty");
            if (this.allowMultipleAuthorizationRequests) { // ì„¸ì…˜ì— ì €ì¥
                Map<String, OAuth2AuthorizationRequest> authorizationRequests = this.getAuthorizationRequests(request);
                authorizationRequests.put(state, authorizationRequest);
                request.getSession().setAttribute(this.sessionAttributeName, authorizationRequests);
            } else {
                request.getSession().setAttribute(this.sessionAttributeName, authorizationRequest);
            }

        }
}

public OAuth2AuthorizationRequest loadAuthorizationRequest(HttpServletRequest request) {
        Assert.notNull(request, "request cannot be null");
        String stateParameter = this.getStateParameter(request);
        if (stateParameter == null) {
            return null;
        } else {
            Map<String, OAuth2AuthorizationRequest> authorizationRequests = this.getAuthorizationRequests(request);
            return (OAuth2AuthorizationRequest)authorizationRequests.get(stateParameter);
        }
}
```

  - ì¸ì¦ ê³¼ì • (OAuth2LoginAuthenticationFilter)
```java
public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response) throws AuthenticationException {
        MultiValueMap<String, String> params = OAuth2AuthorizationResponseUtils.toMultiMap(request.getParameterMap());
        if (!OAuth2AuthorizationResponseUtils.isAuthorizationResponse(params)) { // params : state, session_state, codeê°€ ì „ë‹¬
            OAuth2Error oauth2Error = new OAuth2Error("invalid_request");
            throw new OAuth2AuthenticationException(oauth2Error, oauth2Error.toString());
        } else {
            OAuth2AuthorizationRequest authorizationRequest = this.authorizationRequestRepository.removeAuthorizationRequest(request, response);
            if (authorizationRequest == null) {
                OAuth2Error oauth2Error = new OAuth2Error("authorization_request_not_found");
                throw new OAuth2AuthenticationException(oauth2Error, oauth2Error.toString());
            } else {
                String registrationId = (String)authorizationRequest.getAttribute("registration_id");
                ClientRegistration clientRegistration = this.clientRegistrationRepository.findByRegistrationId(registrationId);
                if (clientRegistration == null) {
                    OAuth2Error oauth2Error = new OAuth2Error("client_registration_not_found", "Client Registration not found with Id: " + registrationId, (String)null);
                    throw new OAuth2AuthenticationException(oauth2Error, oauth2Error.toString());
                } else {
                    String redirectUri = UriComponentsBuilder.fromHttpUrl(UrlUtils.buildFullRequestUrl(request)).replaceQuery((String)null).build().toUriString();
                    OAuth2AuthorizationResponse authorizationResponse = OAuth2AuthorizationResponseUtils.convert(params, redirectUri);
                    Object authenticationDetails = this.authenticationDetailsSource.buildDetails(request);
                    OAuth2LoginAuthenticationToken authenticationRequest = new OAuth2LoginAuthenticationToken(clientRegistration, new OAuth2AuthorizationExchange(authorizationRequest, authorizationResponse));
                    authenticationRequest.setDetails(authenticationDetails);
                    OAuth2LoginAuthenticationToken authenticationResult = (OAuth2LoginAuthenticationToken)this.getAuthenticationManager().authenticate(authenticationRequest);
                    OAuth2AuthenticationToken oauth2Authentication = (OAuth2AuthenticationToken)this.authenticationResultConverter.convert(authenticationResult);
                    Assert.notNull(oauth2Authentication, "authentication result cannot be null");
                    oauth2Authentication.setDetails(authenticationDetails);
                    OAuth2AuthorizedClient authorizedClient = new OAuth2AuthorizedClient(authenticationResult.getClientRegistration(), oauth2Authentication.getName(), authenticationResult.getAccessToken(), authenticationResult.getRefreshToken());
                    this.authorizedClientRepository.saveAuthorizedClient(authorizedClient, oauth2Authentication, request, response);
                    return oauth2Authentication;
                }
            }
        }
}
```

2. ê·¸ ì™¸ì˜ URLë¡œ ì ‘ê·¼
   - LoginUrlAuthenticationEntryPoint ë¡œ ì´ë™
```java
ublic void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException) throws IOException, ServletException {
        String redirectUrl;
        if (!this.useForward) { // ì¸ì¦ ë°›ì§€ ëª»í•˜ë©´, AuthenticationEntryPointë¥¼ í†µí•´ ì•„ë˜ redirectUrlë¡œ ì´ë™í•˜ê²Œ í•¨
            redirectUrl = this.buildRedirectUrlToLoginPage(request, response, authException);
            this.redirectStrategy.sendRedirect(request, response, redirectUrl); // redirectUrl : http://localhost:8081/oauth2/authorization/keycloak (ì¦‰, ì´ ê³¼ì •ì„ í†µí•´ ì¸ì¦ì„ ë°›ë„ë¡ í•˜ê²Œ ì²˜ë¦¬) [ë‹¨, authoziation_code ë°©ì‹ì—ë§Œ ì ìš©]
        } else {
            redirectUrl = null;
            if (this.forceHttps && "http".equals(request.getScheme())) {
                redirectUrl = this.buildHttpsRedirectUrlForRequest(request);
            }

            if (redirectUrl != null) {
                this.redirectStrategy.sendRedirect(request, response, redirectUrl);
            } else {
                String loginForm = this.determineUrlToUseForThisRequest(request, response, authException);
                logger.debug(LogMessage.format("Server side forward to: %s", loginForm));
                RequestDispatcher dispatcher = request.getRequestDispatcher(loginForm);
                dispatcher.forward(request, response);
            }
        }
}
```
