-----
### ê°œë…
-----
1. ì¸ê°€ ë°›ì€ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì˜ë¯¸í•˜ëŠ” í´ë˜ìŠ¤
2. ìµœì¢… ì‚¬ìš©ì (ë¦¬ì†ŒìŠ¤ ì†Œìœ ì)ê°€ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë¦¬ì†ŒìŠ¤ë¥¼ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ë¶€ì—¬í•˜ë©´, í´ë¼ì´ì–¸íŠ¸ë¥¼ ì¸ê°€ëœ í´ë¼ì´ì–¸íŠ¸ë¡œ ê°„ì£¼
3. Aceess Tokenê³¼ Refresh Tokenì„ ClientRegsitration (í´ë¼ì´ì–¸íŠ¸)ì™€ ê¶Œí•œì„ ë¶€ì—¬í•œ ìµœì¢… ì‚¬ìš©ìì¸ Principalê³¼ í•¨ê»˜ ë¬¶ì–´ì¤Œ
4. Access Tokenì„ ì´ìš©í•´ì„œ ë¦¬ì†ŒìŠ¤ ì„œë²„ì˜ ìì›ì— ì ‘ê·¼í•  ìˆ˜ ìˆìœ¼ë©°, ì¸ê°€ ì„œë²„ì™€ì˜ í†µì‹ ìœ¼ë¡œ í† í°ì„ ê²€ì¦í•  ìˆ˜ ìˆìŒ
5. ClientRegistrationê³¼ Access Tokenì„ ì‚¬ìš©í•´ì„œ UserInfo ì—”ë“œ í¬ì¸íŠ¸ë¡œ ìš”ì²­ ê°€ëŠ¥

<div align="center">
<img src="https://github.com/user-attachments/assets/4a1ffac1-9ff2-4abd-b458-69a87a99fcca">
</div>

-----
### OAuth2AuthorizedClientRepository
-----
1. ë‹¤ë¥¸ ì›¹ ìš”ì²­ì´ ì™€ë„ ë™ì¼í•œ OAuth2AuthorizedClientë¥¼ ìœ ì§€í•˜ëŠ” ì—­í•  ë‹´ë‹¹
2. OAuth2AuthorizedClientServiceì—ê²Œ OAuth2AuthorizedClientì˜ ì €ì¥, ì¡°í¬, ì‚­ì œ ì²˜ë¦¬ ìœ„ì„

<div align="center">
<img src="https://github.com/user-attachments/assets/09f373e5-2634-45b8-b1bf-658d03c52389">
</div>

-----
### OAuth2AuthorizedClientService
-----
: ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ OAuth2AuthorizedClientë¥¼ ê´€ë¦¬(ì €ì¥, ì¡°íšŒ, ì‚­ì œ)í•˜ëŠ” ì—­í•  ë‹´ë‹¹

<div align="center">
<img src="https://github.com/user-attachments/assets/f6af0a2f-6e3f-4889-9449-cae16edce4ef">
</div>

-----
### ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ í™œìš©
-----
1. OAuth2AuthorizedClientRepositoryë‚˜ OAuth2AuthorizedClientServiceëŠ” OAuth2AuthorizedClientì—ì„œ OAuth2AccessTokenì„ ì°¾ì„ ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ ì œê³µ
2. ë³´í˜¸ ì¤‘ì¸ ë¦¬ì†ŒìŠ¤ ìš”ì²­ì„ ì‹œì‘í•  ë•Œ ì‚¬ìš© ê°€ëŠ¥

<div align="center">
<img src="https://github.com/user-attachments/assets/437d4f33-7bf6-48e2-a806-ec2a0c0eea28">
</div>

-----
### OAuth2AuthorizationCodeGrantFilter
-----
1. ê°œë…
   - Authorization Code Grant ë°©ì‹ìœ¼ë¡œ ê¶Œí•œ ë¶€ì—¬ ìš”ì²­ì„ ì§€ì›í•˜ëŠ” í•„í„°
   - ì¸ê°€ ì„œë²„ë¡œë¶€í„° Redirect ë˜ë©´ì„œ, ì „ë‹¬ëœ codeë¥¼ ì¸ê°€ ì„œë²„ì˜ Access Tokenìœ¼ë¡œ êµí™˜
   - OAuth2AuthorizedClientRepositoryë¥¼ ì‚¬ìš©í•˜ì—¬ OAuth2AuthorizedClientë¥¼ ì €ì¥ í›„ í´ë¼ì´ì–¸íŠ¸ì˜ Redirect URIë¡œ ì´ë™

<div align="center">
<img src="https://github.com/user-attachments/assets/2c85299b-2c58-4604-9c40-3aa37b298f45">
</div>

2. ğŸ’¡ ì‹¤í–‰ ì¡°ê±´
   - ìš”ì²­ íŒŒë¼ë¯¸í„°ì— codeì™€ state ê°’ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
   - OAuth2AuthorizationRequestê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸

-----
### ì½”ë“œ
-----
1. OAuth2AuthorizedClient
```java
private final ClientRegistration clientRegistration;
private final String principalName;
private final OAuth2AccessToken accessToken;
private final OAuth2RefreshToken refreshToken;

public OAuth2AuthorizedClient(ClientRegistration clientRegistration, String principalName, OAuth2AccessToken accessToken) {
        this(clientRegistration, principalName, accessToken, (OAuth2RefreshToken)null);
}

public OAuth2AuthorizedClient(ClientRegistration clientRegistration, String principalName, OAuth2AccessToken accessToken, @Nullable OAuth2RefreshToken refreshToken) {
        Assert.notNull(clientRegistration, "clientRegistration cannot be null");
        Assert.hasText(principalName, "principalName cannot be empty");
        Assert.notNull(accessToken, "accessToken cannot be null");
        this.clientRegistration = clientRegistration;
        this.principalName = principalName;
        this.accessToken = accessToken;
        this.refreshToken = refreshToken;
}
```

2. OAuth2WebSecurityConfiguration
```java
@Bean
@ConditionalOnMissingBean
    OAuth2AuthorizedClientService authorizedClientService(ClientRegistrationRepository clientRegistrationRepository) {
        return new InMemoryOAuth2AuthorizedClientService(clientRegistrationRepository); // OAuth2AuthorizedClientService ìƒì„±
}

@Bean
@ConditionalOnMissingBean
    OAuth2AuthorizedClientRepository authorizedClientRepository(OAuth2AuthorizedClientService authorizedClientService) {
        return new AuthenticatedPrincipalOAuth2AuthorizedClientRepository(authorizedClientService); // OAuth2AuthorizedClientRepository ìƒì„±
}
```

3. HomeController
```java
package io.security.oauth2.springsecurityoauth2;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class HomeController {

    @GetMapping("/home")
    public String home() {
        return "home";
    }
}
```

  - home.html
```html
<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
  <meta charset="UTF-8">
  <title>Insert title here</title>
  <script>
    function authorizationCode(){
      window.location = new URL('http://localhost:8081/oauth2/authorization/keycloak');
    }

    function password(){
      window.location = new URL('http://localhost:8081/oauth2/authorization/keycloak2');
    }

    function clientCredentials(){
      window.location = new URL('http://localhost:8081/oauth2/authorization/keycloak3');
    }


  </script>
</head>
<body>
<div>Welcome</div>
<form sec:authorize="isAnonymous()" action="#">
  <p><input type="button" onclick="authorizationCode()" value="AuthorizationCode Grant" />
  <p><input type="button" onclick="password()" value="Resource Owner Password Grant" />
  <p><input type="button" onclick="clientCredentials()" value="Client Credentials Grant" />
</form>
</body>
</html>
```

4. OAuth2ClientConfig
```java
package io.security.oauth2.springsecurityoauth2;

import org.springframework.context.annotation.Bean;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.web.SecurityFilterChain;

@EnableWebSecurity
public class OAuth2ClientConfig {
    @Bean
    SecurityFilterChain oauth2ClientSecurityFilterChain(HttpSecurity http) throws Exception {
        http.authorizeRequests(auth -> auth
                .antMatchers("/home").permitAll()
                .anyRequest()
                .authenticated());
        
        http.oauth2Client(Customizer.withDefaults());

        http.logout().logoutSuccessUrl("/home");
        return http.build();
    }
}
```

  - application.yml
```yml
server:
  port: 8081

spring:
  security:
    oauth2:
      client: ## prefix
        registration: ## í´ë¼ì´ì–¸íŠ¸ ì„¤ì • (Map ì†ì„±)
          keycloak1: ## (Mapì˜ í‚¤ ê°’)
            authorizationGrantType: authorization_code
            clientId: oauth2-client-app
            clientName: oauth2-client-app
            clientSecret: zxMvv3yCjZVoEJFAUzNUdYlJgJla9yuf
            clientAuthenticationMethod: client_secret_basic
            redirectUri: http://localhost:8081/client
            scope: openid, profile
            provider: keycloak

        provider: ## : ê³µê¸‰ì ì„¤ì • (Map ì†ì„±)
            keycloak: ## (Mapì˜ í‚¤ ê°’)
              authorizationUri: http://localhost:8080/realms/oauth2/protocol/openid-connect/auth
              issuerUri: http://localhost:8080/realms/oauth2
              jwkSetUri: http://localhost:8080/realms/oauth2/protocol/openid-connect/certs
              tokenUri: http://localhost:8080/realms/oauth2/protocol/openid-connect/token
              userInfoUri: http://localhost:8080/realms/oauth2/protocol/openid-connect/userinfo
              userNameAttribute: preferred_username
```

5. ClientController
```java
package io.security.oauth2.springsecurityoauth2;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.oauth2.client.OAuth2AuthorizedClient;
import org.springframework.security.oauth2.client.OAuth2AuthorizedClientService;
import org.springframework.security.oauth2.client.authentication.OAuth2AuthenticationToken;
import org.springframework.security.oauth2.client.userinfo.DefaultOAuth2UserService;
import org.springframework.security.oauth2.client.userinfo.OAuth2UserRequest;
import org.springframework.security.oauth2.client.userinfo.OAuth2UserService;
import org.springframework.security.oauth2.client.web.OAuth2AuthorizedClientRepository;
import org.springframework.security.oauth2.core.OAuth2AccessToken;
import org.springframework.security.oauth2.core.user.OAuth2User;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;

import javax.servlet.http.HttpServletRequest;
import java.util.Arrays;

@Controller
public class ClientController {

    @Autowired
    private OAuth2AuthorizedClientRepository oauth2AuthorizedClientRepository;

    @Autowired
    private OAuth2AuthorizedClientService oauth2AuthorizedClientService;

    @GetMapping("/client")
    public String client(Authentication authentication, HttpServletRequest request, Model model) {

        String clientRegistrationId = "keycloak";

        // OAuth2AuthorizedClientRepository - loadAuthorizedClientRepository(clientRegistrationId, principal, request)
        OAuth2AuthorizedClient authorizedClient1 = oauth2AuthorizedClientRepository.loadAuthorizedClient(clientRegistrationId, authentication, request);

        // OAuth2AuthorizedClientService - loadAuthorizedClientRepository(clientRegistrationId, principalName)
        OAuth2AuthorizedClient authorizedClient2 = oauth2AuthorizedClientService.loadAuthorizedClient(clientRegistrationId, authentication.getName());

        OAuth2AccessToken accessToken = authorizedClient1.getAccessToken();

        // ì‚¬ìš©ì ì¸ì¦ ì²˜ë¦¬
        // OAuth2UserService ìƒì„±
        OAuth2UserService oAuth2UserService = new DefaultOAuth2UserService();

        // OAuth2UserServiceë¥¼ í†µí•´, OAuth2User ìƒì„±
        OAuth2User oAuth2User = oAuth2UserService.loadUser(new OAuth2UserRequest(authorizedClient1.getClientRegistration(), accessToken));

        // ìµœì¢… ì¸ì¦ ê°ì²´ ìƒì„±
        OAuth2AuthenticationToken authenticationToken = new OAuth2AuthenticationToken(oAuth2User, Arrays.asList(new SimpleGrantedAuthority("ROLE_USER")), authorizedClient1.getClientRegistration().getRegistrationId());

        SecurityContextHolder.getContext().setAuthentication(authenticationToken);

        model.addAttribute("accessToken", accessToken.getTokenValue());
        model.addAttribute("refreshToken", authorizedClient1.getRefreshToken().getTokenValue());
        model.addAttribute("principalName", oAuth2User.getName());
        model.addAttribute("clientName", authorizedClient1.getClientRegistration().getClientName());

        return "client";
    }
}
```

  - client.html
```html
<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <title>Insert title here</title>

</head>
<body>
<div>Welcome</div><p></p>
<div sec:authorize="isAuthenticated()"><a th:href="@{/logout}">Logout</a></div><br>
<div sec:authorize="isAuthenticated()">principalName: <span th:text="${principalName}">ì¸ê°€ë°›ì€ í´ë¼ì´ì–¸íŠ¸</span></div><br>
<div sec:authorize="isAuthenticated()">clientName: <span th:text="${clientName}">ì¸ê°€ë°›ì€ í´ë¼ì´ì–¸íŠ¸</span></div><br>
<div sec:authorize="isAuthenticated()">accessToken: <span th:text="${accessToken}">ì¸ê°€ë°›ì€ í´ë¼ì´ì–¸íŠ¸</span></div><br>
<div sec:authorize="isAuthenticated()">refreshToken: <span th:text="${refreshToken}">ì¸ê°€ë°›ì€ í´ë¼ì´ì–¸íŠ¸</span></div><br>
</body>
</html>
```
