-----
### OAuth2AuthorizedClientManager ê°œë…
-----
1. OAuth2AuthorizedClientë¥¼ ì „ë°˜ì ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤
2. OAuth2AuthorizedClientProviderë¡œ OAuth 2.0 í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ê¶Œí•œ ë¶€ì—¬
   - Client Credentials Flow
   - Resource Owner Password Flow
   - Refresh Token Flow

3. ğŸ’¡ OAuth2AuthorizedClientServiceë‚˜ OAuth2AuthorizedClientRepositoryì— OAuth2AuthoziedClient ì €ì¥ì„ ìœ„ì„í•œ í›„, OAuth2AuthorizedClient ìµœì¢… ë°˜í™˜
4. ì‚¬ìš©ì ì •ì˜ OAuth2AuthorizationSuccessHandler ë° OAuth2AuthorizationFailureHandlerë¥¼ êµ¬ì„±í•˜ì—¬ ì„±ê³µ / ì‹¤íŒ¨ ì²˜ë¦¬ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŒ
5. invalid_grant ì˜¤ë¥˜ë¡œ ì¸í•´ ê¶Œí•œ ë¶€ì—¬ ì‹œë„ ì‹¤íŒ¨í•˜ë©´ OAuth2AuthorizedClientê°€ OAuth2AuthorizedClientRepositoryì—ì„œ ì œê±°

<div align="center">
<img src="https://github.com/user-attachments/assets/1db108f7-1da5-43a8-81d5-5dde286215bd">
</div>

-----
### êµ¬ì¡° ë° íŠ¹ì§•
-----
<div align="center">
<img src="https://github.com/user-attachments/assets/f36eca3d-3c2a-49c0-997b-67111e32c4ac">
</div>

<div align="center">
<img src="https://github.com/user-attachments/assets/8eb416d8-fb76-4a2d-bcb1-ad2001aaa97c">
</div>

-----
### ìƒì„±
-----
<div align="center">
<img src="https://github.com/user-attachments/assets/babff455-0187-480d-9532-cd827b10e3db">
</div>

-----
### ê¸°ë³¸ í™˜ê²½ êµ¬ì„±
-----
1. ê°œìš”
   - ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì˜ OAuth2Login í•„í„°ì— ì˜í•œ ìë™ ì¸ì¦ ì²˜ë¦¬ë¥¼ í•˜ì§€ ì•Šê³ , DefaultOAuth2AuthorizedClientManager í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•´ Spring MVCì—ì„œ ì§ì ‘ ì¸ì¦ ì²˜ë¦¬ë¥¼ í•˜ëŠ” ë¡œê·¸ì¸ ê¸°ëŠ¥ êµ¬í˜„
<div align="center">
<img src="https://github.com/user-attachments/assets/fcfb87e5-d0bf-47b9-959a-dffa4c03f17d">
</div>

2. ê¸°ë³¸ êµ¬ì„±
   - AppConfig : DefaultOAuth2AuthorizedClientManager ë¹ˆ ìƒì„± ë° ì„¤ì • ì´ˆê¸°í™”
   - DefaultOAuth2AuthorizedClientManager : OAuth2 ê¶Œí•œ ë¶€ì—¬ íë¦„ ì²˜ë¦¬
   - LoginController : DefaultOAuth2AuthorizedClientManagerë¥¼ ì‚¬ìš©í•´ ë¡œê·¸ì¸ ì²˜ë¦¬
   - home.html : ì¸ì¦ë°›ì€ ì‚¬ìš©ìë§Œ ì ‘ê·¼ ê°€ëŠ¥
   - index.html, client.html : ì•„ë¬´ë‚˜ ì ‘ê·¼ ê°€ëŠ¥
   - application.yml : ê¶Œí•œ ë¶€ì—¬ ìœ í˜•ì„ client_credentials, password, refresh íƒ€ì…ìœ¼ë¡œ ì„¤ì •

3. ë¡œê·¸ì¸ êµ¬í˜„ ìˆœì„œ
   - DefaultOAuth2AuthorizedClientManager ë¹ˆ ìƒì„± ë° íŒŒë¼ë¯¸í„° ì´ˆê¸° ê°’ë“¤ ì •ì˜
   - ê¶Œí•œ ë¶€ì—¬ ìœ í˜•ì— ë”°ë¼ ìš”ì²­ì´ ì´ë£¨ì–´ì§€ë„ë¡ application.yml ì„¤ì • ì¡°ì •
   - /oauth2Login ì£¼ì†Œë¡œ ê¶Œí•œ ë¶€ì—¬ íë¦„ ìš”ì²­
   - DefaultOAuth2AuthorizedClientManagerì—ê²Œ ê¶Œí•œ ë¶€ì—¬ ìš”ì²­
   - ê¶Œí•œ ë¶€ì—¬ì— ì„±ê³µí•˜ëŠ” OAuth2AuthorizationSuccessHandlerë¥¼ í˜¸ì¶œí•˜ì—¬ ì¸ì¦ ì´í›„ ì‘ì—… ì§„í–‰
     + DefaultOAuth2AuthorizedClientManagerì˜ ìµœì¢… ë°˜í™˜ ê°’ì¸ OAuth2AuthorizedCLientë¥¼ OAuth2AuthoziedClientRepositoryì— ì €ì¥

   - OAuth2AuthorizedClientì—ì„œ Access Tokenì„ ì°¸ì¡°í•˜ì—¬ /userinfo ì—”ë“œí¬ì¸íŠ¸ ìš”ì²­ìœ¼ë¡œ ìµœì¢… ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜´
   - ì‚¬ìš©ì ì •ë³´ì™€ ê¶Œí•œì„ ê°€ì§€ê³  ì¸ì¦ ê°ì²´ë¥¼ ë§Œë“  í›„, SecurityContextì— ì €ì¥í•˜ê³  ì¸ì¦ ì™„ë£Œ
   - ì¸ì¦ì´ ì„±ê³µí•˜ë©´ ìœ„ ê³¼ì •ì„ ì»¤ìŠ¤í…€ í•„í„°ë¡œ ë§Œë“¤ì–´ì„œ ì²˜ë¦¬

-----
### ê¸°ë³¸ í™˜ê²½ êµ¬ì„± ì½”ë“œ
-----
1. index.html
```html
<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
  <meta charset="UTF-8">
  <title>Insert title here</title>
  <script>
    function authorizationCode(){
      window.location = new URL('http://localhost:8081/oauth2/authorization/keycloak');
    
    }


  </script>
</head>
<body>
<div>Welcome</div>
<form sec:authorize="isAnonymous()" action="#">
  <p><input type="button" onclick="authorizationCode()" value="AuthorizationCode Grant" />
</form>
</body>
</html>
```

   - home.html
```html
<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
  <meta charset="UTF-8">
  <title>Insert title here</title>
</head>
<body>
<div>Welcome <span th:text = "${oAuth2AuthenticationToken}"/></div>
<div>
    <a href="@{/logout}">Logout</a>
</div>
</body>
</html>
```


2. LoginController
```java
package io.security.oauth2.springsecurityoauth2.controller;

import org.springframework.security.core.Authentication;
import org.springframework.security.web.authentication.logout.SecurityContextLogoutHandler;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@Controller
public class LoginController {
    
    @GetMapping("/oauth2Login")
    public String oauth2Login(HttpServletRequest request, HttpServletResponse response, Model model) {
        return "redirect:/";
    }
    
    @GetMapping("/logout")
    public String logout(Authentication authentication, HttpServletRequest request, HttpServletResponse response) {
        SecurityContextLogoutHandler logoutHandler = new SecurityContextLogoutHandler();
        
        logoutHandler.logout(request, response, authentication);
        
        return "redirect:/";
    }
}
```

   - index.html
```html
package io.security.oauth2.springsecurityoauth2.controller;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;

@Controller
public class IndexController {

    @GetMapping("/")
    public String index() {
        return "index";
    }
}
```

3. AppConfig
```java
package io.security.oauth2.springsecurityoauth2.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.oauth2.client.OAuth2AuthorizedClientManager;
import org.springframework.security.oauth2.client.OAuth2AuthorizedClientProvider;
import org.springframework.security.oauth2.client.OAuth2AuthorizedClientProviderBuilder;
import org.springframework.security.oauth2.client.registration.ClientRegistrationRepository;
import org.springframework.security.oauth2.client.web.DefaultOAuth2AuthorizedClientManager;
import org.springframework.security.oauth2.client.web.OAuth2AuthorizedClientRepository;

@Configuration
public class AppConfig {
    
    @Bean
    public OAuth2AuthorizedClientManager authorizedClientManager(ClientRegistrationRepository clientRegistrationRepository, OAuth2AuthorizedClientRepository clientRepository) {
        OAuth2AuthorizedClientProvider oAuth2AuthorizedClientProvider 
                                                                   = OAuth2AuthorizedClientProviderBuilder.builder()
                                                                                                           .authorizationCode()
                                                                                                           .password()
                                                                                                           .clientCredentials()
                                                                                                           .refreshToken()
                                                                                                           .build();

        DefaultOAuth2AuthorizedClientManager oAuth2AuthorizedClientManager = new DefaultOAuth2AuthorizedClientManager(clientRegistrationRepository, clientRepository);
        
        oAuth2AuthorizedClientManager.setAuthorizedClientProvider(oAuth2AuthorizedClientProvider);
        
        return oAuth2AuthorizedClientManager;
    }
}
```

4. OAuth2ClientConfig
```java
package io.security.oauth2.springsecurityoauth2.config;

import org.springframework.context.annotation.Bean;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.web.SecurityFilterChain;

@EnableWebSecurity
public class OAuth2ClientConfig {
    @Bean
    SecurityFilterChain oauth2ClientSecurityFilterChain(HttpSecurity http) throws Exception {
        http.authorizeRequests(auth -> auth
                .antMatchers("/", "/oauth2Login","/client").permitAll()
                .anyRequest()
                .authenticated());

        http.oauth2Client(Customizer.withDefaults());

        return http.build();
    }
}
```
