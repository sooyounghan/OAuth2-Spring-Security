-----
### ProviderContext (0.4.x ì´í›„ : AuthorizationServerContext)
-----
1. ProviderContext (0.4.x ì´í›„ : AuthorizationServerContext)
   - ê³µê¸‰ìì— ëŒ€í•œ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ì»¨í…ŒìŠ¤íŠ¸ ê°ì²´
   - ê³µê¸‰ì ì„¤ì • ë° í˜„ì¬ issuerì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ ì œê³µ

2. ProviderContextHolder (0.4.x ì´í›„ : AuthorizationServerContextHolder)
   - ProviderContextë¥¼ ê°€ì§€ê³  ìˆìŒ
   - ThreadLocalì„ ì‚¬ìš©í•´ í˜„ì¬ ìš”ì²­ ìŠ¤ë ˆë“œì™€ ì—°ê²°ë˜ì–´ ìˆëŠ”, ProviderContextë¥¼ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í•¨

3. ProviderContextFilter (0.4.x ì´í›„ : AuthorizationServerContextFilter)
   - ProviderContextHolderì™€ ProviderContext ì—°ê²°

<div align="center">
<img src="https://github.com/user-attachments/assets/53277161-6d5a-4e0f-97bb-92a0bbe37b7f">
</div>

-----
### ì½”ë“œ
-----
1. ProviderContextFilter
```java
private final ProviderSettings providerSettings; // Provider ì—”ë“œí¬ì¸íŠ¸ ì •ë³´ë¥¼ ì €ì¥

protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        try {
            ProviderContext providerContext = new ProviderContext(this.providerSettings, () -> { // í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ë§ˆë‹¤ ProviderContext ìƒì„±
                return resolveIssuer(this.providerSettings, request); // resolverIssuer : Supplier
            });
            ProviderContextHolder.setProviderContext(providerContext);
            filterChain.doFilter(request, response);
        } finally {
            ProviderContextHolder.resetProviderContext(); // ë‹¤ì‹œ ì‚­ì œ
        }
}

private static String resolveIssuer(ProviderSettings providerSettings, HttpServletRequest request) {
        return providerSettings.getIssuer() != null ? providerSettings.getIssuer() : getContextPath(request); // nullì´ë©´ getContextPathì— request ì •ë³´ë¡œ ìƒì„±
}

private static String getContextPath(HttpServletRequest request) {
        return UriComponentsBuilder.fromHttpUrl(UrlUtils.buildFullRequestUrl(request)).replacePath(request.getContextPath()).replaceQuery((String)null).fragment((String)null).build().toUriString();
}
```

2. ProviderContext
```java
public ProviderContext(ProviderSettings providerSettings, @Nullable Supplier<String> issuerSupplier) { // Supplier : get 
        Assert.notNull(providerSettings, "providerSettings cannot be null");
        this.providerSettings = providerSettings;
        this.issuerSupplier = issuerSupplier;
}

public String getIssuer() {
        return this.issuerSupplier != null ? (String)this.issuerSupplier.get() : this.getProviderSettings().getIssuer(); // getí•˜ë©´, resolverIssuerë¡œ ì´ë™
}
```

3. ProviderContextHolder
```java
private static final ThreadLocal<ProviderContext> holder = new ThreadLocal();

public static void setProviderContext(ProviderContext providerContext) {
        if (providerContext == null) { // Nullì´ë©´,
            resetProviderContext(); // ì—†ì•°
        } else {
            holder.set(providerContext); // ìˆë‹¤ë©´, ì €ì¥
        }
}
```

4. AuthorizationServerConfig2
```java
package io.security.oauth2.springsecurityoauth2;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.OAuth2AuthorizationServerConfiguration;
import org.springframework.security.oauth2.core.AuthorizationGrantType;
import org.springframework.security.oauth2.core.ClientAuthenticationMethod;
import org.springframework.security.oauth2.core.oidc.OidcScopes;
import org.springframework.security.oauth2.server.authorization.client.InMemoryRegisteredClientRepository;
import org.springframework.security.oauth2.server.authorization.client.RegisteredClient;
import org.springframework.security.oauth2.server.authorization.client.RegisteredClientRepository;
import org.springframework.security.oauth2.server.authorization.config.ClientSettings;
import org.springframework.security.oauth2.server.authorization.config.ProviderSettings;
import org.springframework.security.web.SecurityFilterChain;

import java.util.UUID;

/*
    OAuth2AuthorizationServerConfiguration.applyDefaultSecurity() static ë©”ì„œë“œ ì´ìš©
 */
@Configuration
public class AuthorizationServerConfig2 {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        OAuth2AuthorizationServerConfiguration.applyDefaultSecurity(http);
        return http.build();
    }

    @Bean 
    public ProviderSettings providerSettings() { // ğŸ’¡ ë°˜ë“œì‹œ ì •ì˜ (ì„œë¹„ìŠ¤ ì œê³µìì˜ ì •ë³´ë¥¼ ë‹´ê³ ìˆìœ¼ë¯€ë¡œ ë°˜ë“œì‹œ í•„ìš”)
        return ProviderSettings.builder().issuer("http://localhost:9000").build(); // issuer ì •ë³´ í•„ìš” (ì—†ìœ¼ë©´, getContextPathë¡œ request ì •ë³´ ë°”íƒ•ìœ¼ë¡œ ìƒì„±)
    }

    @Bean
    public RegisteredClientRepository registeredClientRepository() { // í•„ìˆ˜ë¡œ í•„ìš”
        // í´ë¼ì´ì–¸íŠ¸ ë“±ë¡
        RegisteredClient registeredClient = RegisteredClient.withId(UUID.randomUUID().toString())
                .clientId("oauth2-client-app")
                .clientSecret("{noop}secret")
                .clientAuthenticationMethod(ClientAuthenticationMethod.CLIENT_SECRET_BASIC)
                .clientAuthenticationMethod(ClientAuthenticationMethod.NONE)
                .authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE)
                .authorizationGrantType(AuthorizationGrantType.REFRESH_TOKEN)
                .authorizationGrantType(AuthorizationGrantType.CLIENT_CREDENTIALS)
                .redirectUri("http://localhost:8081/login/oauth2/code/oauth2-client-app")
                .redirectUri("http://localhost:8081")
                .scope(OidcScopes.OPENID)
                .scope("read")
                .scope("write")
                .clientSettings(ClientSettings.builder().requireAuthorizationConsent(true).build())
                .build();

        InMemoryRegisteredClientRepository registeredClientRepository = new InMemoryRegisteredClientRepository(registeredClient);

        return registeredClientRepository;
    }
}
```
