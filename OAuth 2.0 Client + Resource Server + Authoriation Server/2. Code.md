-----
### SharedObject : Í≥µÌÜµÏ†Å ÎèÑÎ©îÏù∏ Î™®Ïùå
-----
1. build.gradle
```gradle
plugins {
    id 'org.springframework.boot' version '2.7.2'
    id 'io.spring.dependency-management' version '1.0.12.RELEASE'
    id 'java'
}

group = 'io.security'
version = '0.0.1-SNAPSHOT'
sourceCompatibility = '11'

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter'
    compileOnly 'org.projectlombok:lombok'
    annotationProcessor 'org.springframework.boot:spring-boot-configuration-processor'
    annotationProcessor 'org.projectlombok:lombok'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
}

tasks.named('test') {
    useJUnitPlatform()
}
```

2. AccessToken
```java
package io.sharedobject.sharedobject;

import lombok.Data;

import java.io.Serializable;

@Data
public class AccessToken implements Serializable {
    private String token;
}
```

3. Friend
```java
package io.sharedobject.sharedobject;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.io.Serializable;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class Friend implements Serializable {
    private String name;
    private int age;
    private String gender;
}
```

4. MyInfo
```java
package io.sharedobject.sharedobject;

import lombok.Builder;
import lombok.Data;

import java.util.List;

@Data
@Builder
public class MyInfo {
    private List<Photo> photos;
    private List<Friend> friends;
}
```

5. Photo
```java
package io.sharedobject.sharedobject;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.io.Serializable;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class Photo implements Serializable {
    private String userId;
    private String photoId;
    private String photoTitle;
    private String photoDescription;
}
```

-----
### OAuth2Client
-----
1. build.gradle
```gradle
plugins {
	id 'org.springframework.boot' version '2.7.2'
	id 'io.spring.dependency-management' version '1.0.12.RELEASE'
	id 'java'
}

group = 'io.OAuth2Client'
version = '0.0.1-SNAPSHOT'
sourceCompatibility = '11'

configurations {
	compileOnly {
		extendsFrom annotationProcessor
	}
}

repositories {
	mavenCentral()
}

dependencies {
	implementation 'org.springframework.boot:spring-boot-starter-security'
	implementation 'org.springframework.boot:spring-boot-starter-web'
	compileOnly 'org.projectlombok:lombok'
	compileOnly project(':SharedObject')
	annotationProcessor 'org.springframework.boot:spring-boot-configuration-processor'
	annotationProcessor 'org.projectlombok:lombok'
	implementation 'org.springframework.boot:spring-boot-starter-oauth2-client'
	implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'
	implementation 'org.thymeleaf.extras:thymeleaf-extras-springsecurity5'
}

tasks.named('test') {
	useJUnitPlatform()
}
```

  - settings.gradle
```gradle
rootProject.name = 'OAuth2Client'
include ':SharedObject'
project(':SharedObject').projectDir = new File(settingsDir, '../SharedObject')
```

2. application.yml
```yml
server:
  port: 8081
spring:
  security:
    oauth2:
      client:
        provider:
          springOAuth2:
            authorization-uri: http://localhost:9000/oauth2/authorize
            issuer-uri: http://localhost:9000
            jwk-set-uri: http://localhost:9000/oauth2/jwks
            token-uri: http://localhost:9000/oauth2/token
            user-info-uri: http://localhost:9000/userinfo
            #user-name-attribute: preferred_username
        registration:
          springOAuth2:
            authorization-grant-type: authorization_code
            client-id: oauth2-client-app1
            client-name: oauth2-client-app
            client-secret: secret1
            redirect-uri: http://127.0.0.1:8081/login/oauth2/code/springoauth2
            #scope: openid,read,write
            scope: openid,read,write,photo,friend
```

3. resources/templates
   - index.html
```html
<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
    <script>
        function token(){
            fetch("/token")
                .then(response => {
                    response.json().then(function(data){
                        console.log("text ÏïàÏóê Îç∞Ïù¥ÌÑ∞ = " + data.tokenValue);
                        window.localStorage.setItem("access_token", data.tokenValue);
                        location.href = "/home";
                    })
                })
        }
    </script>
</head>
<body>
<div>OAuth2.0 Client</div>
<div sec:authorize="isAnonymous()"><a th:href="@{/oauth2/authorization/springOAuth2}">Login</a></div>
<div sec:authorize="isAuthenticated()">
<form action="#">
    <p><input type="button" onclick="token()" value="access token" />
</form>
</div>
</body>
</html>
```

  - home.html
```html
<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <title>Insert title here</title>
    <script>
        function photos() {
            fetch("http://localhost:8082/photos", {
                method: "GET",
                headers: {
                    Authorization: "Bearer " + localStorage.getItem("access_token")
                }
            })
                .then(response => {
                    response.json().then(function (data) {
                        for (const prop in data) {
                            document.querySelector("#remotePhotos").append(data[prop].userId);
                            document.querySelector("#remotePhotos").append(data[prop].photoId);
                            document.querySelector("#remotePhotos").append(data[prop].photoTitle);
                            document.querySelector("#remotePhotos").append(data[prop].photoDescription);
                            document.querySelector("#remotePhotos").append(document.createElement('br'));
                        }
                    })
                })
        }


        function myInfo() {
            fetch("http://localhost:8082/myInfo", {
                method: "GET",
                headers: {
                    Authorization: "Bearer " + localStorage.getItem("access_token")
                }
            })
                .then(response => {
                    response.json().then(function (data) {
                        let photos = data["photos"];
                        let friends = data["friends"];
                        for (let i = 0; i < photos.length; i++) {
                            document.querySelector("#albums").append(photos[i].photoId);
                            document.querySelector("#albums").append(photos[i].userId);
                            document.querySelector("#albums").append(photos[i].photoTitle);
                            document.querySelector("#albums").append(photos[i].photoDescription);
                            document.querySelector("#albums").append(document.createElement('br'));
                        }

                        for (let i = 0; i < friends.length; i++) {
                            document.querySelector("#friends").append(friends[i].name);
                            document.querySelector("#friends").append(friends[i].age);
                            document.querySelector("#friends").append(friends[i].gender);
                            document.querySelector("#friends").append(document.createElement('br'));
                        }
                    })
                })
                .catch((error) => console.log("error:", error));
        }

        function tokenExpire() { // ÌÜ†ÌÅ∞Ïù¥ ÏÉàÎ°úÏö¥ ÌÜ†ÌÅ∞ Í∞íÏúºÎ°ú Î≥ÄÍ≤Ω
            fetch("/tokenExpire?token=" + localStorage.getItem("access_token"),
                {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                    },
                })
                .then(response => { // ÌÜ†ÌÅ∞ ÎßåÎ£åÏóê ÎåÄÌïú ÏùëÎãµÏùÑ Î∞õÏùå
                    response.json().then(function (data) {
                        fetch("/newAccessToken", // Ïù¥Ïóê ÎåÄÌï¥ Î∞îÎ°ú Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÎã§Í≥† Í∞ÄÏ†ïÌïòÍ≥†, /newAccessToken Ìò∏Ï∂ú
                            {
                                method: "GET",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                            })
                            .then(response => {
                                response.json().then(function (data) {
                                    console.log("text ÏïàÏóê Îç∞Ïù¥ÌÑ∞ = " + data.tokenValue);
                                    window.localStorage.setItem("access_token", data.tokenValue);
                                    location.href = "/home";
                                })
                            })
                            .catch((error) => console.log("error:", error));
                    })
                })
                .catch((error) => console.log("error:", error));
        }

    </script>
</head>
<body>
<div>Welcome</div>
<div sec:authorize="isAuthenticated()"><a th:href="@{/logout}">Logout</a></div>
<form action="#">
    <p><input type="button" onclick="photos()" value="Photos"/>
    <p><input type="button" onclick="myInfo()" value="MyInfo"/>
    <p><input type="button" onclick="tokenExpire()" value="tokenExpire"/>
</form>
<div id="photos"></div>
<p></p>
<div id="remotePhotos"></div>

</p>
<div id="albums"></div>

<p></p>
<div id="friends"></div>
</body>
</html>
```

4. OAuth2ClientConfig
```java
package io.oauth2client.oauth2client;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.oauth2.client.OAuth2AuthorizedClientManager;
import org.springframework.security.oauth2.client.OAuth2AuthorizedClientProvider;
import org.springframework.security.oauth2.client.OAuth2AuthorizedClientProviderBuilder;
import org.springframework.security.oauth2.client.registration.ClientRegistrationRepository;
import org.springframework.security.oauth2.client.web.DefaultOAuth2AuthorizedClientManager;
import org.springframework.security.oauth2.client.web.OAuth2AuthorizedClientRepository;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.web.client.RestTemplate;

@Configuration
public class OAuth2ClientConfig {

    @Bean
    SecurityFilterChain oauth2SecurityFilterChain(HttpSecurity http) throws Exception {
        http.authorizeRequests((requests) -> requests.antMatchers("/","/photos").permitAll().anyRequest().authenticated());
        http.oauth2Login(authLogin -> authLogin.defaultSuccessUrl("/"));
        http.oauth2Client();
        return http.build();
    }

    @Bean
    public RestTemplate restTemplate(){
        return new RestTemplate();
    }

    @Bean
    public DefaultOAuth2AuthorizedClientManager authorizedClientManager(ClientRegistrationRepository clientRegistrationRepository,
                                                                        OAuth2AuthorizedClientRepository authorizedClientRepository) { // DefaultOAuth2AuthorizedClientManager Ï∂îÍ∞Ä

        OAuth2AuthorizedClientProvider authorizedClientProvider =
                OAuth2AuthorizedClientProviderBuilder.builder()
                        .authorizationCode()
                        .clientCredentials()
                        .password()
                        .refreshToken()
                        .build();

        DefaultOAuth2AuthorizedClientManager authorizedClientManager =
                new DefaultOAuth2AuthorizedClientManager(
                        clientRegistrationRepository, authorizedClientRepository);
        authorizedClientManager.setAuthorizedClientProvider(authorizedClientProvider);

        return authorizedClientManager;
    }
}
```

5. IndexController
```java
package io.oauth2client.oauth2client;

import org.springframework.security.oauth2.client.OAuth2AuthorizedClient;
import org.springframework.security.oauth2.client.annotation.RegisteredOAuth2AuthorizedClient;
import org.springframework.security.oauth2.core.OAuth2AccessToken;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@Controller
public class IndexController {

    @GetMapping("/")
    public String index(){
        return "index";
    }

    @GetMapping("/home")
    public String home(){
        return "home";
    }
}
```

6. RestApiContorller
```java
package io.oauth2client.oauth2client;

import io.sharedobject.sharedobject.AccessToken;
import lombok.RequiredArgsConstructor;
import org.springframework.core.ParameterizedTypeReference;
import org.springframework.http.*;
import org.springframework.http.client.ClientHttpResponse;
import org.springframework.security.oauth2.client.OAuth2AuthorizeRequest;
import org.springframework.security.oauth2.client.OAuth2AuthorizedClient;
import org.springframework.security.oauth2.client.OAuth2AuthorizedClientService;
import org.springframework.security.oauth2.client.annotation.RegisteredOAuth2AuthorizedClient;
import org.springframework.security.oauth2.client.authentication.OAuth2AuthenticationToken;
import org.springframework.security.oauth2.client.registration.ClientRegistration;
import org.springframework.security.oauth2.client.web.DefaultOAuth2AuthorizedClientManager;
import org.springframework.security.oauth2.core.AuthorizationGrantType;
import org.springframework.security.oauth2.core.OAuth2AccessToken;
import org.springframework.security.oauth2.core.OAuth2Error;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.ResponseErrorHandler;
import org.springframework.web.client.RestTemplate;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import static org.springframework.http.HttpStatus.Series.CLIENT_ERROR;
import static org.springframework.http.HttpStatus.Series.SERVER_ERROR;

@RestController
@RequiredArgsConstructor
public class RestApiController {

    private final RestTemplate restTemplate;
    private final DefaultOAuth2AuthorizedClientManager oAuth2AuthorizedClientManager;
    private final OAuth2AuthorizedClientService authorizedClientService;

    @GetMapping("/token")
    public OAuth2AccessToken token(@RegisteredOAuth2AuthorizedClient("springOAuth2") OAuth2AuthorizedClient oAuth2AuthorizedClient){
        return oAuth2AuthorizedClient.getAccessToken();
    }

    @GetMapping("/tokenExpire")
    public Map<String,Object> tokenExpire(AccessToken accessToken){ // ÌÜ†ÌÅ∞ ÎßåÎ£å ÏãúÏ†êÏù¥ ÎêòÏóàÏùÑ Îïå Ìò∏Ï∂ú

        HttpHeaders header = new HttpHeaders();
        header.add("Authorization", "Bearer " + accessToken.getToken());  // üí° 8082 ÏÑúÎ≤ÑÎ°ú Ï†ÑÏÜ°ÌïòÏßÄÎßå, Ïù¥ Ïó≠Ïãú ÌÜ†ÌÅ∞ Í≤ÄÏ¶ù ÌïÑÏöî (Ïù¥ ÌÜ†ÌÅ∞Ïù¥ ÎßåÎ£åÎêú ÌÜ†ÌÅ∞Ïù∏ÏßÄ ÏïÑÎãåÏßÄ)
        HttpEntity<?> entity = new HttpEntity<>(header);
        String url = "http://localhost:8082/tokenExpire";
        ResponseEntity<Map<String,Object>> response = restTemplate.exchange(url, HttpMethod.GET, entity, new ParameterizedTypeReference<>() {}); // üí° ÌÜ†ÌÅ∞Ïù¥ ÎßåÎ£åÎêòÏóàÎäîÏßÄ Ï†ÑÏÜ°ÌïòÍ≥†, ÎßåÎ£åÎêòÏóàÎã§Îäî ÏùëÎãµÏùÑ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÍ≤å Ï†ÑÎã¨

        return response.getBody();
    }

    @GetMapping("/newAccessToken")
    public OAuth2AccessToken newAccessToken(OAuth2AuthenticationToken authentication, HttpServletRequest request, HttpServletResponse response){ // ÏÉàÎ°úÏö¥ Access Token Î∞úÍ∏â

	// OAuth2AuthorizedClient Ï∂îÏ∂ú (ÌòÑÏû¨ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Îäî Ïù∏Í∞ÄÎ•º Î∞õÏùå) : Refresh TokenÏùÑ ÌÜµÌï¥ Access Token Ïû¨Î∞úÍ∏âÏùÑ ÌïòÍ∏∞ ÏúÑÌï®Ïù∏Îç∞, Ïù¥ Ï†ïÎ≥¥Í∞Ä OAuth2AuthorizedClientÏóê Ï°¥Ïû¨ (Îî∞ÎùºÏÑú, ClientRegistrationIdÏôÄ, Í∑∏ Ïù∏Ï¶ù Í∞ùÏ≤¥ Ïù¥Î¶ÑÏùÑ ÌååÎùºÎØ∏ÌÑ∞Î°ú Î∞õÏùå)
        OAuth2AuthorizedClient authorizedClient
                = authorizedClientService.loadAuthorizedClient(authentication.getAuthorizedClientRegistrationId(), authentication.getName());

        if (authorizedClient != null && authorizedClient.getRefreshToken() != null) {

            ClientRegistration clientRegistration = ClientRegistration.withClientRegistration
                            (authorizedClient.getClientRegistration()).authorizationGrantType(AuthorizationGrantType.REFRESH_TOKEN) // Authorization Grant TypeÏùÑ Refresh TokenÏúºÎ°ú Î≥ÄÍ≤ΩÌï¥ÏÑú Ï≤òÎ¶¨
                    .build();

            OAuth2AuthorizedClient oAuth2AuthorizedClient =
                    new OAuth2AuthorizedClient(clientRegistration, authorizedClient.getPrincipalName(),
                            authorizedClient.getAccessToken(),authorizedClient.getRefreshToken()); // Refresh TokenÏúºÎ°ú Î≥ÄÍ≤Ω

            OAuth2AuthorizeRequest oAuth2AuthorizeRequest =
                    OAuth2AuthorizeRequest.withAuthorizedClient(oAuth2AuthorizedClient)
                            .principal(authentication)
                            .attribute(HttpServletRequest.class.getName(), request)
                            .attribute(HttpServletResponse.class.getName(), response)
                            .build();

	    // AuthorizedClientManager (RefreshTokenOAuth2AuthorizedClientProvider -> OAuth2RefreshTokenAuthenticationProvider) Î•º ÌÜµÌï¥ Refresh TokenÏùÑ ÌÜµÌï¥ Access TokenÏùÑ Ïû¨Î∞úÍ∏â
            authorizedClient = oAuth2AuthorizedClientManager.authorize(oAuth2AuthorizeRequest);
        }

        return authorizedClient.getAccessToken();
    }
}
```

-----
### ResourceServer
-----
1. build.gradle
```gradle
plugins {
    id 'org.springframework.boot' version '2.7.2'
    id 'io.spring.dependency-management' version '1.0.12.RELEASE'
    id 'java'
}

group = 'io.ResourceServer'
version = '0.0.1-SNAPSHOT'
sourceCompatibility = '11'

repositories {
    mavenCentral()
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'org.springframework.boot:spring-boot-starter-web'
    compileOnly 'org.projectlombok:lombok'
    compileOnly project(':SharedObject')
    annotationProcessor 'org.springframework.boot:spring-boot-configuration-processor'
    annotationProcessor 'org.projectlombok:lombok'
    implementation 'org.springframework.boot:spring-boot-starter-oauth2-resource-server'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
}

tasks.named('test') {
    useJUnitPlatform()
}
```

  - settings.gradle
```gradle
rootProject.name = 'ResourceServer'
include ':SharedObject'
project(':SharedObject').projectDir = new File(settingsDir, '../SharedObject')
```

2. application.yml
```yml
server:
  port: 8082

spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          jwk-set-uri: http://localhost:9000/oauth2/jwks # Í≤ÄÏ¶ùÏùÑ ÏúÑÌïú Jwk Set Uri
```

3. OAuth2ResourceServer
```java
package io.resourceserver.resourceserver;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.annotation.Order;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.oauth2.server.resource.introspection.OpaqueTokenIntrospector;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

@Configuration
public class OAuth2ResourceServer {

    @Bean
    SecurityFilterChain securityFilterChain1(HttpSecurity http) throws Exception {

        http.authorizeRequests(
                (requests) -> requests
                        .antMatchers("/photos","/remotePhotos","/myInfo").access("hasAuthority('SCOPE_photo')")
                        .anyRequest().authenticated());
        http.oauth2ResourceServer().jwt(); // üí° Access Token (ÌÜ†ÌÅ∞ ÏïàÏóêÎäî ÎèôÏùòÌïú SCOPE Ìè¨Ìï®) Í≤ÄÏ¶ùÏùÑ ÏúÑÌï¥ ÌïÑÏöî
        http.cors().configurationSource(corsConfigurationSource());
        return http.build();
    }

    @Bean

    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.addAllowedOrigin("*");
        configuration.addAllowedMethod("*");
        configuration.addAllowedHeader("*");
        configuration.setMaxAge(3600L);
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration);

        return source;

    }

    @Bean
    public RestTemplate restTemplate(){
        return new RestTemplate();
    }
}
```

4. IndexController
```java
package io.resourceserver.resourceserver;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class IndexController {

    @GetMapping("/")
    public String index(){
        return "index";
    }
}
```

5. MyInfoController
```java
package io.resourceserver.resourceserver;

import io.sharedobject.sharedobject.Friend;
import io.sharedobject.sharedobject.MyInfo;
import io.sharedobject.sharedobject.Photo;
import lombok.RequiredArgsConstructor;
import org.springframework.core.ParameterizedTypeReference;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.ResponseEntity;
import org.springframework.security.oauth2.core.OAuth2AuthenticatedPrincipal;
import org.springframework.security.oauth2.server.resource.BearerTokenAuthenticationToken;
import org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationToken;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

import java.util.Arrays;
import java.util.List;

@RestController
@RequiredArgsConstructor
public class MyInfoController {

    private final RestTemplate restTemplate;

    @GetMapping("/myInfo")
    public MyInfo myInfo(JwtAuthenticationToken authenticationToken){

        HttpHeaders header = new HttpHeaders();
        header.add("Authorization", "Bearer " + authenticationToken.getToken().getTokenValue()); // üí° 8083, Ï¶â Resource Server2Ïóê Ï†ëÍ∑ºÌï† ÎïåÎèÑ ÏûêÏõêÏóê Ï†ëÍ∑ºÌïòÎäî Í≤ÉÏù¥ÎØÄÎ°ú ÌÜ†ÌÅ∞ ÌïÑÏöîÌïòÎØÄÎ°ú Ìó§ÎçîÏóê ÌÜ†ÌÅ∞ Í∞í Ï∂îÍ∞Ä
        HttpEntity<?> entity = new HttpEntity<>(header);
        String url = "http://localhost:8083/friends"; // üí° 8082, 8083ÏúºÎ°ú Ï†ÑÏÜ°ÎêòÏñ¥ÎèÑ, 8082, 8083ÏóêÏÑúÎèÑ ÎòêÌïú ÌÜ†ÌÅ∞Ïóê ÎåÄÌïú Í≤ÄÏ¶ù ÌïÑÏöî -> Ïù∏Í∞Ä ÏÑúÎ≤ÑÎ°ú Í≤ÄÏ¶ù ÏöîÏ≤≠ ÌõÑ Í≤ÄÏ¶ù 
        ResponseEntity<List<Friend>> response = restTemplate.exchange(url, HttpMethod.GET, entity, new ParameterizedTypeReference<>(){}); // ÏπúÍµ¨ Î™©Î°ùÍ≥º ÏÇ¨ÏßÑÏùÑ Í∞ÄÏ†∏Ïò¥

        Photo photo1 = PhotoService.getBuild("1 ", "Album1 title ", "Album is nice ", "user1");
        Photo photo2 = PhotoService.getBuild("2 ", "Album2 title ", "Album is beautiful ", "user2");

        return MyInfo.builder().photos(Arrays.asList(photo1, photo2)).friends(response.getBody()).build();
    }
}
```

6. PhotoContorller
```java
package io.resourceserver.resourceserver;

import io.sharedobject.sharedobject.Photo;
import org.springframework.security.oauth2.core.OAuth2Error;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@RestController
public class PhotoController {

    @GetMapping("/photos")
    public List<Photo> photos(){

        Photo photo1 = PhotoService.getBuild("1 ", "Photo1 title ", "Photo is nice ", "user1 ");
        Photo photo2 = PhotoService.getBuild("2 ", "Photo2 title ", "Photo is beautiful ", "user2 ");

        return Arrays.asList(photo1, photo2);
    }


    @GetMapping("/tokenExpire")
    public Map<String, Object> tokenExpire(){ // ÌÜ†ÌÅ∞ ÎßåÎ£å

        Map<String, Object> result = new HashMap<>();
        result.put("error",new OAuth2Error("invalid token", "token is expired", null)); // OAuth2Error Ï†ÑÏÜ° -> ÏµúÏ¢Ö Î∏åÎùºÏö∞Ï†ÄÏóê ÏùëÎãµ (OAuth2Client)

        return result;
    }
}
```

7. PhotoService
```java
package io.resourceserver.resourceserver;

import io.sharedobject.sharedobject.Photo;

public class PhotoService {

    public static Photo getBuild(String photoId, String photoTitle, String description, String user1) {
        return Photo.builder()
                .photoId(photoId)
                .photoTitle(photoTitle)
                .photoDescription(description)
                .userId(user1)
                .build();
    }

}
```

-----
### ResourceServer2
-----
1. build.gradle
```gradle
plugins {
	id 'org.springframework.boot' version '2.7.2'
	id 'io.spring.dependency-management' version '1.0.12.RELEASE'
	id 'java'
}

group = 'io.ResourceServer2'
version = '0.0.1-SNAPSHOT'
sourceCompatibility = '11'

repositories {
	mavenCentral()
}

dependencies {
	implementation 'org.springframework.boot:spring-boot-starter-security'
	implementation 'org.springframework.boot:spring-boot-starter-web'
	compileOnly 'org.projectlombok:lombok'
	compileOnly project(':SharedObject')
	annotationProcessor 'org.springframework.boot:spring-boot-configuration-processor'
	annotationProcessor 'org.projectlombok:lombok'
	implementation 'org.springframework.boot:spring-boot-starter-oauth2-resource-server'
	testImplementation 'org.springframework.boot:spring-boot-starter-test'
}

tasks.named('test') {
	useJUnitPlatform()
}
```

  - settings.gradle
```gradle
rootProject.name = 'ResourceServer2'
include ':SharedObject'
project(':SharedObject').projectDir = new File(settingsDir, '../SharedObject')
```

2. application.yml
```yml
server:
  port: 8083

spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          jwk-set-uri: http://localhost:9000/oauth2/jwks # Í≤ÄÏ¶ùÏùÑ ÏúÑÌïú Jwk Set Uri
```

3. OAuth2ResourceServer
```java
package io.resourceserver2.resourceserver2;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

@Configuration
public class OAuth2ResourceServer {

    @Bean
    SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {

        http.authorizeRequests(
                (requests) -> requests
                        .antMatchers("/friends").access("hasAuthority('SCOPE_friend')")
                        .anyRequest().authenticated());
        http.oauth2ResourceServer().jwt(); // üí° Access Token (ÌÜ†ÌÅ∞ ÏïàÏóêÎäî ÎèôÏùòÌïú SCOPE Ìè¨Ìï®) Í≤ÄÏ¶ùÏùÑ ÏúÑÌï¥ ÌïÑÏöî
        http.cors().configurationSource(corsConfigurationSource());
        return http.build();
    }
    @Bean
    public CorsConfigurationSource corsConfigurationSource() { // Ï∂úÏ≤òÍ∞Ä Îã§Î•∏ Îëê Í≥≥ÏùÑ ÏÑúÎ°ú Í≥µÏú†ÌïòÎØÄÎ°ú CORS ÏÑ§Ï†ï ÌïÑÏöî
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.addAllowedOrigin("*");
        configuration.addAllowedMethod("*");
        configuration.addAllowedHeader("*");
        configuration.setMaxAge(3600L);
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration);

        return source;

    }
}
```

4. IndexController
```java
package io.resourceserver2.resourceserver2;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class IndexController {

    @GetMapping("/")
    public String index(){
        return "index";
    }
}
```

5. FriendController
```java
package io.resourceserver2.resourceserver2;

import io.sharedobject.sharedobject.Friend;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.Arrays;
import java.util.List;

@RestController
public class FriendController {

    @GetMapping("/friends")
    public List<Friend> friends(){

        Friend friend1 = getFriend("friend1 ", 10 , " man ");
        Friend friend2 = getFriend("friend2 ", 11 , " woman ");

        return Arrays.asList(friend1, friend2);
    }

    private Friend getFriend(String name, int age, String gender) {
        return Friend.builder()
                .name(name)
                .age(age)
                .gender(gender)
                .build();
    }
}
```

-----
### AuthorizationServer
-----
1. build.gradle
```gradle
plugins {
	id 'org.springframework.boot' version '2.7.1'
	id 'io.spring.dependency-management' version '1.0.11.RELEASE'
	id 'java'
}

group = 'io.AuthorizationServer'
version = '0.0.1-SNAPSHOT'
sourceCompatibility = '11'

configurations {
	compileOnly {
		extendsFrom annotationProcessor
	}
}

repositories {
	mavenCentral()
}

dependencies {
	implementation 'org.springframework.boot:spring-boot-starter-security'
	implementation 'org.springframework.boot:spring-boot-starter-web'
	implementation 'org.springframework.security:spring-security-oauth2-authorization-server:0.3.1'
	compileOnly 'org.projectlombok:lombok'

	annotationProcessor 'org.springframework.boot:spring-boot-configuration-processor'
	annotationProcessor 'org.projectlombok:lombok'
	testImplementation 'org.springframework.boot:spring-boot-starter-test'
	testImplementation 'org.springframework.security:spring-security-test'
}

tasks.named('test') {
	useJUnitPlatform()
}
```

2. applicaiton.yml
```yml
server:
  port: 9000
```

3. AppConfig
```java
package io.authorizationserver.authorizationserver;

import com.nimbusds.jose.jwk.JWKSet;
import com.nimbusds.jose.jwk.RSAKey;
import com.nimbusds.jose.jwk.source.JWKSource;
import com.nimbusds.jose.proc.SecurityContext;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.oauth2.core.AuthorizationGrantType;
import org.springframework.security.oauth2.core.ClientAuthenticationMethod;
import org.springframework.security.oauth2.core.oidc.OidcScopes;
import org.springframework.security.oauth2.server.authorization.InMemoryOAuth2AuthorizationConsentService;
import org.springframework.security.oauth2.server.authorization.InMemoryOAuth2AuthorizationService;
import org.springframework.security.oauth2.server.authorization.OAuth2AuthorizationConsentService;
import org.springframework.security.oauth2.server.authorization.OAuth2AuthorizationService;
import org.springframework.security.oauth2.server.authorization.client.InMemoryRegisteredClientRepository;
import org.springframework.security.oauth2.server.authorization.client.RegisteredClient;
import org.springframework.security.oauth2.server.authorization.client.RegisteredClientRepository;
import org.springframework.security.oauth2.server.authorization.config.ClientSettings;
import org.springframework.security.oauth2.server.authorization.config.ProviderSettings;
import org.springframework.security.oauth2.server.authorization.config.TokenSettings;

import java.security.KeyPair;
import java.security.KeyPairGenerator;
import java.security.NoSuchAlgorithmException;
import java.security.interfaces.RSAPrivateKey;
import java.security.interfaces.RSAPublicKey;
import java.time.Duration;
import java.time.Instant;
import java.util.Arrays;
import java.util.UUID;

@Configuration
public class AppConfig {

    @Bean
    public ProviderSettings providerSettings(){
        return ProviderSettings.builder().issuer("http://localhost:9000").build();
    }

    @Bean
    public RegisteredClientRepository registeredClientRepository(){

        RegisteredClient registeredClient1= getRegisteredClient("oauth2-client-app1", "{noop}secret1", "read", "write");
        RegisteredClient registeredClient2= getRegisteredClient("oauth2-client-app2", "{noop}secret2", "read", "delete");
        RegisteredClient registeredClient3= getRegisteredClient("oauth2-client-app3", "{noop}secret3", "read", "update");

        return new InMemoryRegisteredClientRepository(Arrays.asList(registeredClient1,registeredClient2,registeredClient3));

    }

    private RegisteredClient getRegisteredClient(String clientId, String clientSecret, String scope1, String scope2) {
        return RegisteredClient.withId(UUID.randomUUID().toString())
                .clientId(clientId)
                .clientSecret(clientSecret)
                .clientName(clientId)
                .clientIdIssuedAt(Instant.now())
                .clientSecretExpiresAt(Instant.MAX)
                .clientAuthenticationMethod(ClientAuthenticationMethod.CLIENT_SECRET_BASIC)
                .clientAuthenticationMethod(ClientAuthenticationMethod.CLIENT_SECRET_POST)
                .authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE)
                .authorizationGrantType(AuthorizationGrantType.CLIENT_CREDENTIALS)
                .authorizationGrantType(AuthorizationGrantType.REFRESH_TOKEN)
                .redirectUri("http://127.0.0.1:8081")
                .redirectUri("http://127.0.0.1:8081/login/oauth2/code/springoauth2") // Redirect URI ÌïòÎÇò Ï∂îÍ∞Ä
                .scope(OidcScopes.OPENID)
                .scope(OidcScopes.PROFILE)
                .scope(OidcScopes.EMAIL)
                .scope(scope1)
                .scope(scope2)
                .scope("photo") // photo Scope Ï∂îÍ∞Ä
                .scope("friend") // friend Scope Ï∂îÍ∞Ä
                .clientSettings(ClientSettings.builder().requireAuthorizationConsent(true).build())
                // .tokenSettings(TokenSettings.builder().accessTokenTimeToLive(Duration.ofSeconds(1L)).build()) // Access TokenÏùò ÎßåÎ£å Í∏∞Í∞Ñ : 1Ï¥à (üí° Resfresh TokenÎ•º Ïù¥Ïö©Ìïú Ïû¨Î∞úÍ∏â ÏÇ¨Ïö© Ïãú Ïù¥ ÏΩîÎìú ÏÇ¨Ïö©Ìï† ÏòàÏ†ï)
                .build();
    }

    @Bean
    public JWKSource<SecurityContext> jwkSource() throws NoSuchAlgorithmException {
        RSAKey rsaKey = generateRsa();
        JWKSet jwkSet = new JWKSet(rsaKey);

        return (jwkSelector, context) -> jwkSelector.select(jwkSet);
    }

    private RSAKey generateRsa() throws NoSuchAlgorithmException {

        KeyPair keyPair = generateKeyPair();
        RSAPrivateKey rsaPrivateKey = (RSAPrivateKey) keyPair.getPrivate();
        RSAPublicKey rsaPublicKey = (RSAPublicKey) keyPair.getPublic();

        return new RSAKey.Builder(rsaPublicKey)
                .privateKey(rsaPrivateKey)
                .keyID(UUID.randomUUID().toString())
                .build();
    }

    private KeyPair generateKeyPair() throws NoSuchAlgorithmException {
        KeyPairGenerator keyPairGenerator = KeyPairGenerator.getInstance("RSA");
        keyPairGenerator.initialize(2048);
        return keyPairGenerator.generateKeyPair();
    }

    @Bean
    public OAuth2AuthorizationService oAuth2AuthorizationService(){
        return new InMemoryOAuth2AuthorizationService();
    }

    @Bean
    public OAuth2AuthorizationConsentService oAuth2AuthorizationConsentService(){
        return new InMemoryOAuth2AuthorizationConsentService();
    }
}
```

4. DefaultSecurityConfig
```java
package io.authorizationserver.authorizationserver;

import org.springframework.context.annotation.Bean;
import org.springframework.security.authentication.dao.DaoAuthenticationProvider;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.provisioning.InMemoryUserDetailsManager;
import org.springframework.security.web.SecurityFilterChain;

@EnableWebSecurity
public class DefaultSecurityConfig {

    @Bean
    public SecurityFilterChain defaultSecurityFilterChain(HttpSecurity http) throws Exception {

        http.authorizeRequests(request -> request.anyRequest().authenticated());
        http.formLogin();
        DaoAuthenticationProvider daoAuthenticationProvider = new DaoAuthenticationProvider();
        daoAuthenticationProvider.setUserDetailsService(userDetailsService());
        http.authenticationProvider(daoAuthenticationProvider);

        return http.build();
    }

    @Bean
    public UserDetailsService userDetailsService(){
        UserDetails user = User.withUsername("user").password("{noop}1234").authorities("ROLE_USER").build();
        return new InMemoryUserDetailsManager(user);
    }
}
```

5. AuthorizationConfig
```java
package io.authorizationserver.authorizationserver;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.Ordered;
import org.springframework.core.annotation.Order;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configurers.oauth2.server.authorization.OAuth2AuthorizationServerConfigurer;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint;
import org.springframework.security.web.util.matcher.RequestMatcher;

@Configuration(proxyBeanMethods = false)
public class AuthorizationServerConfig {

    @Bean
    @Order(Ordered.HIGHEST_PRECEDENCE)
    public SecurityFilterChain authorizationServerSecurityFilterChain(HttpSecurity http) throws Exception {
        OAuth2AuthorizationServerConfigurer<HttpSecurity> authorizationServerConfigurer =
                new OAuth2AuthorizationServerConfigurer<>();
        RequestMatcher endpointsMatcher = authorizationServerConfigurer.getEndpointsMatcher();

        http
                .requestMatcher(endpointsMatcher)
                .authorizeRequests(authorizeRequests ->
                        authorizeRequests.anyRequest().authenticated()
                )
                .csrf(csrf -> csrf.ignoringRequestMatchers(endpointsMatcher))
                .apply(authorizationServerConfigurer);
        http
                .exceptionHandling(exceptions ->
                        exceptions.authenticationEntryPoint(new LoginUrlAuthenticationEntryPoint("/login"))
                );
        return http.build();
    }
}
```

6. CustomAuthenticationProvider
```java
package io.authorizationserver.authorizationserver;

import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.authentication.AuthenticationProvider;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.oauth2.server.authorization.OAuth2AuthorizationConsentService;
import org.springframework.security.oauth2.server.authorization.OAuth2AuthorizationService;
import org.springframework.security.oauth2.server.authorization.authentication.OAuth2AuthorizationCodeRequestAuthenticationProvider;
import org.springframework.security.oauth2.server.authorization.authentication.OAuth2AuthorizationCodeRequestAuthenticationToken;
import org.springframework.security.oauth2.server.authorization.client.RegisteredClientRepository;
import org.springframework.stereotype.Component;

import java.util.UUID;

@Component
@RequiredArgsConstructor
public class CustomAuthenticationProvider implements AuthenticationProvider {

    private final RegisteredClientRepository registeredClientRepository;
    private final OAuth2AuthorizationService oAuth2AuthorizationService;
    private final OAuth2AuthorizationConsentService oAuth2AuthorizationConsentService;
    @Override
    public Authentication authenticate(Authentication authentication) throws AuthenticationException {

        OAuth2AuthorizationCodeRequestAuthenticationToken authorizationCodeRequestAuthentication =
                (OAuth2AuthorizationCodeRequestAuthenticationToken) authentication;

        OAuth2AuthorizationCodeRequestAuthenticationProvider authenticationProvider
                = new OAuth2AuthorizationCodeRequestAuthenticationProvider(registeredClientRepository, oAuth2AuthorizationService, oAuth2AuthorizationConsentService);
        OAuth2AuthorizationCodeRequestAuthenticationToken authenticate
                = (OAuth2AuthorizationCodeRequestAuthenticationToken)authenticationProvider.authenticate(authorizationCodeRequestAuthentication);

        Authentication principal = (Authentication) authorizationCodeRequestAuthentication.getPrincipal();
        System.out.println("principal = " + principal);

        return authenticate;

    }

    @Override
    public boolean supports(Class<?> authentication) {
        return OAuth2AuthorizationCodeRequestAuthenticationToken.class.isAssignableFrom(authentication);
    }
}
```

-----
### Ï∞∏Í≥†
-----
1. üí° localhostÏóêÏÑú ÏÉùÏÑ±Îêú ÏÑ∏ÏÖòÍ≥º Í∞ùÏ≤¥ÏôÄ 127.0.0.1Î°ú ÏÉùÏÑ±Îêú ÏÑ∏ÏÖòÍ≥º Í∞ùÏ≤¥Îäî Îã§Î¶Ñ
   - üí° Ïù∏Í∞Ä ÏÑúÎ≤ÑÏóêÏÑúÎäî localhostÎ•º ÏõêÏ≤ú Ï∞®Îã® (IPÎÇò ÎèÑÎ©îÏù∏ÏúºÎ°ú Ï†ëÍ∑ºÌï¥ÏïºÌï®)
   
