-----
### ê°œë…
-----
1. OAuth 2.0 ë˜ëŠ” OpenID Connect 1.0 Providerì—ì„œ í´ë¼ì´ì–¸íŠ¸ì˜ ë“±ë¡ ì •ë³´ë¥¼ ë‚˜íƒ€ëƒ„
2. ClientRegistrationì€ OpenID Connect Providerì˜ ì„¤ì • ì—”ë“œí¬ì¸íŠ¸ë‚˜ ì¸ê°€ ì„œë²„ì˜ ë©”íƒ€ë°ì´í„°ë¥¼ ì°¾ì•„ ì´ˆê¸°í™”í•  ìˆ˜ ìˆìŒ
3. ClientRegistrationsì˜ ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ í¸ë¦¬í•˜ê²Œ ClientRegistration ì„¤ì • ê°€ëŠ¥
   - ClientRegistration clientRegistration = ClientRegistrations.fromIssuerLocation(```"http://idp.example.com/issuer"```).build(); [```http://idp.example.com/issuer``` : ì¸ê°€ ì„œë²„ì˜ Host URL]
   - ìœ„ ì½”ë“œëŠ” 200 ì‘ë‹µì„ ë°›ì„ ë•Œ ê¹Œì§€, ```https://idp.example.com/issuer/.well-known/openid-configuration, https://idp.example.com/.well-known/oauth-authorization-server``` (OpenID Connect Providerì˜ ì„¤ì • ì—”ë“œí¬ì¸íŠ¸ë‚˜ ì¸ê°€ ì„œë²„ì˜ ë©”íƒ€ë°ì´í„° ì£¼ì†Œ)ì— ì°¨ë¡€ ëŒ€ë¡œ ì§ˆì˜

<div align="center">
<img src="https://github.com/user-attachments/assets/cd454b76-62d7-42d4-ae23-6eba161b06b3">
</div>

  - ProviderDetails : ì„œë¹„ìŠ¤ ì œê³µì (ì¸ê°€ ì„œë²„)ì˜ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì €ì¥
  - UserInfoEndPoint : ì‚¬ìš©ì ì •ë³´ ì €ì¥

-----
### ClientRegistration ì†ì„±
-----
<div align="center">
<img src="https://github.com/user-attachments/assets/8fe4f2ef-4d4f-4300-aaac-c2277ee87f0e">
</div>

1. registrationId : ClientRegistrationì„ ì‹ë³„í•  ìˆ˜ ìˆëŠ” ìœ ë‹ˆí¬í•œ ID
2. clientId : í´ë¼ì´ì–¸íŠ¸ ì‹ë³„ì
3. clientSecret : í´ë¼ì´ì–¸íŠ¸ Secret
4. clientAuthenticationMethod : providerì—ì„œ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì¸ì¦í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ë©”ì„œë“œ
   - basic, post, none[public í´ë¼ì´ì–¸íŠ¸])ë¥¼ ì§€ì›
     
5. authorizationGrantType : OAuth 2.0 ì¸ê°€ í”„ë ˆì„ì›Œí¬ëŠ” ë„¤ ê°€ì§€ ê¶Œí•œ ë¶€ì—¬ íƒ€ì…ì„ ì •ì˜
   - ì§€ì›í•˜ëŠ” ê°’ì€ authorization-code, implict, client_credentials, password

6. redirectUriTemplate : í´ë¼ì´ì–¸íŠ¸ì— ë“±ë¡í•œ Redirect URL
   - ì‚¬ìš©ìì˜ ì¸ì¦ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ì— ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í•˜ê³  ë‚˜ë©´, ì¸ê°€ ì„œë²„ê°€ ì´ URLë¡œ ìµœì¢… ì‚¬ìš©ìì˜ ë¸Œë¼ìš°ì €ë¥¼ Redirect

7. scopes : ì¸ê°€ ìš”ì²­ Flowì—ì„œ í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­í•œ openid, í”„ë¡œí•„ ë“±ì˜ Scope
8. clientName : í´ë¼ì´ì–¸íŠ¸ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì´ë¦„ìœ¼ë¡œ, ìë™ ìƒì„±ë˜ëŠ” ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œ ë…¸ì¶œí•˜ëŠ” ë“±ì— ì‚¬ìš©
9. authorizationUri : ì¸ê°€ ì„œë²„ì˜ ì¸ê°€ ì—”ë“œí¬ì¸íŠ¸ URL
10. tokenUri : ì¸ê°€ ì„œë²„ í† í° ì—”ë“œí¬ì¸íŠ¸ URL
11. jwkSetUri : ì¸ê°€ ì„œë²„ì—ì„œ JSON ì›¹ í‚¤ (JWK) Setì„ ê°€ì ¸ì˜¬ ë•Œ ì‚¬ìš©í•  URL
    - ì´ Key Setì—” ID Tokenì˜ JSON Web Signature(JWS)ë¥¼ ê²€ì¦í•  ë•Œ ì‚¬ìš©í•  ì•”í˜¸í‚¤ê°€ ì¡´ì¬
    - UserInfo ì‘ë‹µì„ ê²€ì¦í•  ë•Œë„ ì‚¬ìš© ê°€ëŠ¥

12. configurationMetadata : OpenID Provider ì„¤ì • ì •ë³´
    - ğŸ’¡ application.propertiesì— spring.security.oauth2.client.provider.[providerId].issuerUrië¥¼ ì„¤ì •í–ˆì„ ë•Œë§Œ ì‚¬ìš© ê°€ëŠ¥

13. (userInfoEndPoint)uri : ì¸ì¦ëœ ìµœì¢… ì‚¬ìš©ìì˜ í´ë ˆì„ / ì†ì„±ì— ì ‘ê·¼í•  ë•Œ ì‚¬ìš©í•˜ëŠ” UserInfo ì—”ë“œí¬ì¸íŠ¸ URI
14. (userInfoEndPoint)authenticationMethod : UserInfo ì—”ë“œí¬ì¸íŠ¸ë¡œ ì•¡ì„¸ìŠ¤ í† í°ì„ ì „ì†¡í•  ë•Œ ì‚¬ìš©í•  ì¸ì¦ ë©”ì„œë“œ
   - header, form, query ì§€ì›

15. userNameAttribute : UserInfo ì‘ë‹µì— ìˆëŠ” ì†ì„± ì´ë¦„ìœ¼ë¡œ, ìµœì¢… ì‚¬ìš©ìì˜ ì´ë¦„ì´ë‚˜ ì‹ë³„ìì— ì ‘ê·¼í•  ë•Œ ì‚¬ìš©

-----
### CommonOAuth2Provider
-----
<div align="center">
<img src="https://github.com/user-attachments/assets/a2bafcc7-ba16-4ad4-8469-6ed58310f7be">
</div>

1. OAuth 2.0 ê³µê¸‰ì ì •ë³´ë¥¼ ì œê³µí•˜ëŠ” í´ë˜ìŠ¤ë¡œì„œ, ê¸€ë¡œë²Œ ì„œë¹„ìŠ¤ ì œê³µì ì¼ë¶€ëŠ” ê¸°ë³¸ìœ¼ë¡œ ì œê³µ
2. Client IDì™€ Client Secretì€ ë³„ë„ë¡œ applicaition.propertiesì— ì‘ì„±í•´ì•¼ í•¨
3. Naverë‚˜ Kakaoì™€ ê°™ì€ êµ­ë‚´ ê³µê¸‰ì ì •ë³´ëŠ” ìœ„ì˜ ëª¨ë“  í•­ëª©ì„ ìˆ˜ë™ìœ¼ë¡œ ì‘ì„±í•´ì„œ ì‚¬ìš©í•´ì•¼ í•¨
4. í´ë¼ì´ì–¸íŠ¸ì˜ ê¸°ì¤€ì¸ Registration í•­ëª©ê³¼ ì„œë¹„ìŠ¤ ì œê³µì ê¸°ì¤€ì¸ Provider í•­ëª©ì„ êµ¬ë¶„í•˜ì—¬ ì„¤ì •
5. application.propertiesê°€ ì•„ë‹Œ Java Config ë°©ì‹ìœ¼ë¡œ ClientRegistration ë“±ë¡ ì„¤ì • ê°€ëŠ¥
6. ClientRegistration ê°ì²´ë¥¼ ìƒì„±í•  ìˆ˜ ìˆëŠ” ë¹Œë” í´ë˜ìŠ¤ ë°˜í™˜

-----
### ClientRegistration
-----
<div align="center">
<img src="https://github.com/user-attachments/assets/ebeefc5d-3280-488c-9773-dd3fb7419b91">
</div>

-----
### ìœ„ ê³¼ì • ì§„í–‰ ê³¼ì • ì½”ë“œ
-----
1. OAuth2ClientRegistrationRepositoryConfiguration
```java
package org.springframework.boot.autoconfigure.security.oauth2.client.servlet;

import java.util.ArrayList;
import java.util.List;
import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;
import org.springframework.boot.autoconfigure.security.oauth2.client.ClientsConfiguredCondition;
import org.springframework.boot.autoconfigure.security.oauth2.client.OAuth2ClientProperties;
import org.springframework.boot.autoconfigure.security.oauth2.client.OAuth2ClientPropertiesRegistrationAdapter;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Conditional;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.oauth2.client.registration.ClientRegistration;
import org.springframework.security.oauth2.client.registration.ClientRegistrationRepository;
import org.springframework.security.oauth2.client.registration.InMemoryClientRegistrationRepository;

@Configuration(
    proxyBeanMethods = false
)
@EnableConfigurationProperties({OAuth2ClientProperties.class})
@Conditional({ClientsConfiguredCondition.class})
class OAuth2ClientRegistrationRepositoryConfiguration {
    OAuth2ClientRegistrationRepositoryConfiguration() {
    }

    @Bean
    @ConditionalOnMissingBean({ClientRegistrationRepository.class})
    InMemoryClientRegistrationRepository clientRegistrationRepository(OAuth2ClientProperties properties) {
        List<ClientRegistration> registrations = new ArrayList(OAuth2ClientPropertiesRegistrationAdapter.getClientRegistrations(properties).values());
        return new InMemoryClientRegistrationRepository(registrations);
    }
}
```

2. OAuth2ClientPropertiesRegistrationAdapter
```java
public static Map<String, ClientRegistration> getClientRegistrations(OAuth2ClientProperties properties) {
        Map<String, ClientRegistration> clientRegistrations = new HashMap();
        properties.getRegistration().forEach((key, value) -> {
            ClientRegistration var10000 = (ClientRegistration)clientRegistrations.put(key, getClientRegistration(key, value, properties.getProvider()));
        });
        return clientRegistrations;
}

private static ClientRegistration getClientRegistration(String registrationId, OAuth2ClientProperties.Registration properties, Map<String, OAuth2ClientProperties.Provider> providers) {
        ClientRegistration.Builder builder = getBuilderFromIssuerIfPossible(registrationId, properties.getProvider(), providers); // ì¸ê°€ì„œë²„ì— ìœ„ì¹˜í•œ ê²½ë¡œë¥¼ í†µí•´ Metadata
        if (builder == null) {
            builder = getBuilder(registrationId, properties.getProvider(), providers);
        }

        PropertyMapper map = PropertyMapper.get().alwaysApplyingWhenNonNull();
        properties.getClass();

        // application.ymlì—ì„œ ì ìš©, í™˜ê²½ì„¤ì •ì—ì„œ ì ìš©í•œ ê°’ í•œë²ˆ ë” Mapping
        map.from(properties::getClientId).to(builder::clientId);
        properties.getClass();
        map.from(properties::getClientSecret).to(builder::clientSecret);
        properties.getClass();
        map.from(properties::getClientAuthenticationMethod).as(ClientAuthenticationMethod::new).to(builder::clientAuthenticationMethod);
        properties.getClass();
        map.from(properties::getAuthorizationGrantType).as(AuthorizationGrantType::new).to(builder::authorizationGrantType);
        properties.getClass();
        map.from(properties::getRedirectUri).to(builder::redirectUri);
        properties.getClass();
        map.from(properties::getScope).as(StringUtils::toStringArray).to(builder::scope);
        properties.getClass();
        map.from(properties::getClientName).to(builder::clientName);
        return builder.build();
}

private static ClientRegistration.Builder getBuilder(ClientRegistration.Builder builder, OAuth2ClientProperties.Provider provider) {
        PropertyMapper map = PropertyMapper.get().alwaysApplyingWhenNonNull();
        provider.getClass();
        map.from(provider::getAuthorizationUri).to(builder::authorizationUri);
        provider.getClass();
        map.from(provider::getTokenUri).to(builder::tokenUri);
        provider.getClass();
        map.from(provider::getUserInfoUri).to(builder::userInfoUri);
        provider.getClass();
        map.from(provider::getUserInfoAuthenticationMethod).as(AuthenticationMethod::new).to(builder::userInfoAuthenticationMethod);
        provider.getClass();
        map.from(provider::getJwkSetUri).to(builder::jwkSetUri);
        provider.getClass();
        map.from(provider::getUserNameAttribute).to(builder::userNameAttributeName);
        return builder;
}

private static ClientRegistration.Builder getBuilderFromIssuerIfPossible(String registrationId, String configuredProviderId, Map<String, OAuth2ClientProperties.Provider> providers) {
        String providerId = configuredProviderId != null ? configuredProviderId : registrationId;
        if (providers.containsKey(providerId)) {
            OAuth2ClientProperties.Provider provider = (OAuth2ClientProperties.Provider)providers.get(providerId);
            String issuer = provider.getIssuerUri();
            if (issuer != null) {
                ClientRegistration.Builder builder = ClientRegistrations.fromIssuerLocation(issuer).registrationId(registrationId); // issuer ìœ„ì¹˜ë¡œ ê°€ì„œ Builder ë°˜í™˜
                return getBuilder(builder, provider);
            }
        }

        return null;
}
```

3. ClientRegistrations
```java
private static final String OIDC_METADATA_PATH = "/.well-known/openid-configuration";
private static final String OAUTH_METADATA_PATH = "/.well-known/oauth-authorization-server";
  
public static ClientRegistration.Builder fromIssuerLocation(String issuer) {
        Assert.hasText(issuer, "issuer cannot be empty");
        URI uri = URI.create(issuer);
        return getBuilder(issuer, oidc(uri), oidcRfc8414(uri), oauth(uri)); // OIDC, AUTH ë°©ì‹
}

private static Supplier<ClientRegistration.Builder> oidc(URI issuer) {
        URI uri = UriComponentsBuilder.fromUri(issuer).replacePath(issuer.getPath() + "/.well-known/openid-configuration").build(Collections.emptyMap());
        return () -> {
            RequestEntity<Void> request = RequestEntity.get(uri).build();
            Map<String, Object> configuration = (Map)rest.exchange(request, typeReference).getBody(); // í™˜ê²½ì„¤ì •ì—ì„œ ì‘ì„±í•œ ê°’ì„ REST ê°’ìœ¼ë¡œ ë³€ê²½
            OIDCProviderMetadata metadata = (OIDCProviderMetadata)parse(configuration, OIDCProviderMetadata::parse); // OIDCProviderMetadataìœ¼ë¡œ ë³€ê²½
            ClientRegistration.Builder builder = withProviderConfiguration(metadata, issuer.toASCIIString()).jwkSetUri(metadata.getJWKSetURI().toASCIIString());
            if (metadata.getUserInfoEndpointURI() != null) {
                builder.userInfoUri(metadata.getUserInfoEndpointURI().toASCIIString());
            }

            return builder;
        };
}

private static ClientRegistration.Builder withProviderConfiguration(AuthorizationServerMetadata metadata, String issuer) { // ë©”íƒ€ë°ì´í„° ê°’ì„ ClientRegistration ê°ì²´ë¡œ ë³€ê²½
        String metadataIssuer = metadata.getIssuer().getValue();
        Assert.state(issuer.equals(metadataIssuer), () -> {
            return "The Issuer \"" + metadataIssuer + "\" provided in the configuration metadata did not match the requested issuer \"" + issuer + "\"";
        });
        String name = URI.create(issuer).getHost();
        ClientAuthenticationMethod method = getClientAuthenticationMethod(metadata.getTokenEndpointAuthMethods());
        Map<String, Object> configurationMetadata = new LinkedHashMap(metadata.toJSONObject());
        return ClientRegistration.withRegistrationId(name).userNameAttributeName("sub").authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE).clientAuthenticationMethod(method).redirectUri("{baseUrl}/{action}/oauth2/code/{registrationId}").authorizationUri(metadata.getAuthorizationEndpointURI() != null ? metadata.getAuthorizationEndpointURI().toASCIIString() : null).providerConfigurationMetadata(configurationMetadata).tokenUri(metadata.getTokenEndpointURI().toASCIIString()).issuerUri(issuer).clientName(issuer);
}
```

4. CommonOAuth2Provider
```java
package org.springframework.security.config.oauth2.client;

import org.springframework.security.oauth2.client.registration.ClientRegistration;
import org.springframework.security.oauth2.core.AuthorizationGrantType;
import org.springframework.security.oauth2.core.ClientAuthenticationMethod;

public enum CommonOAuth2Provider {
    GOOGLE {
        public ClientRegistration.Builder getBuilder(String registrationId) {
            ClientRegistration.Builder builder = this.getBuilder(registrationId, ClientAuthenticationMethod.CLIENT_SECRET_BASIC, "{baseUrl}/{action}/oauth2/code/{registrationId}");
            builder.scope(new String[]{"openid", "profile", "email"});
            builder.authorizationUri("https://accounts.google.com/o/oauth2/v2/auth");
            builder.tokenUri("https://www.googleapis.com/oauth2/v4/token");
            builder.jwkSetUri("https://www.googleapis.com/oauth2/v3/certs");
            builder.issuerUri("https://accounts.google.com");
            builder.userInfoUri("https://www.googleapis.com/oauth2/v3/userinfo");
            builder.userNameAttributeName("sub");
            builder.clientName("Google");
            return builder;
        }
    },
    GITHUB {
        public ClientRegistration.Builder getBuilder(String registrationId) {
            ClientRegistration.Builder builder = this.getBuilder(registrationId, ClientAuthenticationMethod.CLIENT_SECRET_BASIC, "{baseUrl}/{action}/oauth2/code/{registrationId}");
            builder.scope(new String[]{"read:user"});
            builder.authorizationUri("https://github.com/login/oauth/authorize");
            builder.tokenUri("https://github.com/login/oauth/access_token");
            builder.userInfoUri("https://api.github.com/user");
            builder.userNameAttributeName("id");
            builder.clientName("GitHub");
            return builder;
        }
    },
    FACEBOOK {
        public ClientRegistration.Builder getBuilder(String registrationId) {
            ClientRegistration.Builder builder = this.getBuilder(registrationId, ClientAuthenticationMethod.CLIENT_SECRET_POST, "{baseUrl}/{action}/oauth2/code/{registrationId}");
            builder.scope(new String[]{"public_profile", "email"});
            builder.authorizationUri("https://www.facebook.com/v2.8/dialog/oauth");
            builder.tokenUri("https://graph.facebook.com/v2.8/oauth/access_token");
            builder.userInfoUri("https://graph.facebook.com/me?fields=id,name,email");
            builder.userNameAttributeName("id");
            builder.clientName("Facebook");
            return builder;
        }
    },
    OKTA {
        public ClientRegistration.Builder getBuilder(String registrationId) {
            ClientRegistration.Builder builder = this.getBuilder(registrationId, ClientAuthenticationMethod.CLIENT_SECRET_BASIC, "{baseUrl}/{action}/oauth2/code/{registrationId}");
            builder.scope(new String[]{"openid", "profile", "email"});
            builder.userNameAttributeName("sub");
            builder.clientName("Okta");
            return builder;
        }
    };

    private static final String DEFAULT_REDIRECT_URL = "{baseUrl}/{action}/oauth2/code/{registrationId}";

    private CommonOAuth2Provider() {
    }

    protected final ClientRegistration.Builder getBuilder(String registrationId, ClientAuthenticationMethod method, String redirectUri) {
        ClientRegistration.Builder builder = ClientRegistration.withRegistrationId(registrationId);
        builder.clientAuthenticationMethod(method);
        builder.authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE);
        builder.redirectUri(redirectUri);
        return builder;
    }

    public abstract ClientRegistration.Builder getBuilder(String registrationId);
}
```

   - OAuth2ClientPropertiesRegistrationAdapter
```java
private static ClientRegistration.Builder getBuilder(String registrationId, String configuredProviderId, Map<String, OAuth2ClientProperties.Provider> providers) {
        String providerId = configuredProviderId != null ? configuredProviderId : registrationId; // í™˜ê²½ ì„¤ì •ì—ì„œ ì ìš©í•œ ê°’ì´ ì—†ë‹¤ë©´, registrationId (ê°’ì´ ì—†ìŒ)
        CommonOAuth2Provider provider = getCommonProvider(providerId); // getCommonProviderë¥¼ í˜¸ì¶œ
        if (provider == null && !providers.containsKey(providerId)) {
            throw new IllegalStateException(getErrorMessage(configuredProviderId, registrationId));
        } else {
            ClientRegistration.Builder builder = provider != null ? provider.getBuilder(registrationId) : ClientRegistration.withRegistrationId(registrationId);
            return providers.containsKey(providerId) ? getBuilder(builder, (OAuth2ClientProperties.Provider)providers.get(providerId)) : builder;
        }
}

private static CommonOAuth2Provider getCommonProvider(String providerId) {
        try {
            return (CommonOAuth2Provider)ApplicationConversionService.getSharedInstance().convert(providerId, CommonOAuth2Provider.class); // issuerUriê°€ ì—†ëŠ” ê²½ìš° CommonOAuth2Providerì—ì„œ ì •ì˜í•œ ê°’ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ê°€ì ¸ì˜´
        } catch (ConversionException var2) {
            return null;
        }
}
```

