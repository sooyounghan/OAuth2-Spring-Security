-----
### CORS(Cross-Origin Resource Sharing, êµì°¨ ì¶œì²˜ ë¦¬ì†ŒìŠ¤ ê³µìœ )
-----
1. HTTP í—¤ë”ë¥¼ ì‚¬ìš©í•˜ì—¬, í•œ ì¶œì²˜ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë‹¤ë¥¸ ì¶œì²˜ì˜ ì„ íƒí•œ ìì›ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ë¶€ì—¬í•˜ë„ë¡ ë¸Œë¼ìš°ì €ì— ì•Œë ¤ì£¼ëŠ” ì²´ì œ
2. ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë¦¬ì†ŒìŠ¤ê°€ ìì‹ ì˜ ì¶œì²˜ì™€ ë‹¤ë¥¼ ë•Œ ë¸Œë¼ìš°ì €ëŠ” ìš”ì²­ í—¤ë”ì— Origin í•„ë“œì— ìš”ì²­ ì¶œì²˜ì™€ í•¨ê»˜ ë‹´ì•„ êµì°¨ ì¶œì²˜ HTTP ìš”ì²­ì„ ì‹¤í–‰
3. ì¶œì²˜ë¥¼ ë¹„êµí•˜ëŠ” ë¡œì§ì€ ì„œë²„ì— êµ¬í˜„ëœ ìŠ¤í™ì´ ì•„ë‹Œ ë¸Œë¼ìš°ì €ì— êµ¬í˜„ëœ ìŠ¤í™ ê¸°ì¤€ìœ¼ë¡œ ì²˜ë¦¬ë˜ë©°, ë¸Œë¼ìš°ì €ëŠ” í´ë¦¬ì´ì–¸íŠ¸ì˜ ìš”ì²­ í—¤ë”ì™€ ì„œë²„ì˜ ì‘ë‹µ í—¤ë”ë¥¼ ë¹„êµí•´ì„œ ìµœì¢… ì‘ë‹µì„ ê²°ì •
4. ğŸ’¡ ë‘ ê°œì˜ ì¶œì²˜ë¥¼ ë¹„êµí•˜ëŠ” ë°©ë²•ì€ URL êµ¬ì„± ìš”ì†Œ ì¤‘ Protocol(Scheme), Host, Post ì´ ì„¸ê°€ì§€ê°€ ë™ì¼í•œì§€ í™•ì¸í•˜ë©´ ë˜ë©°, ë‚˜ë¨¸ì§€ëŠ” í‹€ë ¤ë„ ìƒê´€ ì—†ìŒ

<div align="center">
<img src="https://github.com/user-attachments/assets/09029380-dc79-4fc1-b252-b7d0a7711d2a">
</div>

-----
### Simple Request
-----
1. ì˜ˆë¹„ ìš”ì²­(Prefilight)ì„ ê³¼ì • ì—†ì´ ë°”ë¡œ ì„œë²„ì— ìš”ì²­í•œ í›„, ì„œë²„ê°€ ì‘ë‹µì˜ í—¤ë”ì— Access-Control-Allow-Originê³¼ ê°™ì€ ê°’ì„ ì „ì†¡í•˜ë©´, ë¸Œë¼ìš°ì €ê°€ ì„œë¡œ ë¹„êµ í›„ CORS ì •ì±… ìœ„ë°˜ ì—¬ë¶€ë¥¼ ê²€ì‚¬í•˜ëŠ” ë°©ì‹
2. ì œì•½ ì‚¬í•­
   - GET, POST, HEAD ì¤‘ í•œ ê°€ì§€ì˜ ë©”ì„œë“œ ì‚¬ìš©
   - í—¤ë”ëŠ” Accept, Accept-Language, Content-Language, Content-Type, DPR, Downlink, Save-Data, Viewport-Width, Widthë§Œ ê°€ëŠ¥í•˜ê³  Custom HeaderëŠ” í—ˆìš©ë˜ì§€ ì•ŠìŒ
   - Content-Typeì€ applicaiton/x-www-form-urlencoded, mulitpart/form-data, text/plainë§Œ ê°€ëŠ¥
   
<div align="center">
<img src="https://github.com/user-attachments/assets/1ceb2db7-f190-47ef-ac46-b40208ea4a53">
</div>

-----
### Preflight Request (ì˜ˆë¹„ ìš”ì²­)
-----
1. ë¸Œë¼ìš°ì €ëŠ” ìš”ì²­ì„ í•œ ë²ˆì— ë³´ë‚´ì§€ ì•Šê³ , ì˜ˆë¹„ ìš”ì²­ê³¼ ë³¸ ìš”ì²­ì„ ë‚˜ëˆ„ì–´ ì„œë²„ì— ì „ë‹¬í•˜ëŠ”ë° ë¸Œë¼ìš°ì €ê°€ ì˜ˆë¹„ ìš”ì²­ì„ ë³´ë‚´ëŠ” ê²ƒì„ Prfilght ë¼ê³  í•˜ë©°, ì´ ìš”ì²­ì˜ ë©”ì„œë“œëŠ” OPTIONSê°€ ì‚¬ìš©
2. ì˜ˆë¹„ ìš”ì²­ì˜ ë³¸ ì—­í• ì€ ë³¸ ìš”ì²­ì„ ë³´ë‚´ê¸° ì „ ë¸Œë¼ìš°ì €ê°€ ìŠ¤ìŠ¤ë¡œ ì•ˆì „í•œ ìš”ì²­ì¸ì§€ í™•ì¸í•˜ëŠ” ê²ƒ
3. ìš”ì²­ ì‚¬ì–‘ì´ Simple Requestì— í•´ë‹¹í•˜ì§€ ì•Šì„ ê²½ìš°, ë¸Œë¼ìš°ì €ê°€ Preflight Requestë¥¼ ì‹¤í–‰
<div align="center">
<img src="https://github.com/user-attachments/assets/d8c335c9-bb80-4ded-94e8-78691d10adcc">
</div>

<div align="center">
<img src="https://github.com/user-attachments/assets/cd335fd2-af1d-4b15-a386-1c3a5dbb847c">
</div>

-----
### ğŸ’¡ ë™ì¼ ì¶œì²˜ ê¸°ì¤€
-----
<div align="center">
<img src="https://github.com/user-attachments/assets/7ad31ded-af4f-40a5-98b1-1ff78ecdfcc4">
</div>

-----
### CORS í•´ê²° : ì„œë²„ì—ì„œ Access-Contorl-Allow-* ì„¸íŒ…
-----
1. Access-Control-Allow-Origin : í—¤ë”ì— ì‘ì„±ëœ ì¶œì²˜ë§Œ ë¸Œë¼ìš°ì €ê°€ ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©
   - ```*```, ```https://security.io```
  
2. Access-Control-Allow-Methods : Preflight Requestì— ëŒ€í•œ ì‘ë‹µìœ¼ë¡œ ì‹¤ì œ ìš”ì²­ ì¤‘ì— ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë©”ì„œë“œë¥¼ ë‚˜íƒ€ëƒ„
   - ê¸°ë³¸ê°’ : GET, POST, HEAD, OPTIONS, ```*```
  
3. Access-Control-Allow-Headers : Preflight Requestì— ëŒ€í•œ ì‘ë‹µìœ¼ë¡œ ì‹¤ì œ ìš”ì²­ ì¤‘ì— ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í—¤ë” í•„ë“œ ì´ë¦„ì„ ë‚˜íƒ€ëƒ„
   - ê¸°ë³¸ê°’ : Origin, Accept, X-Requested-With, Content-Type, Access-Control-Request-Method, Access-Control-Requst-Headers, Custom Header, ```*```
  
4. Access-Control-Allow-Credentials : ì‹¤ì œ ìš”ì²­ì— ì¿ í‚¤ë‚˜ ì¸ì¦ ë“±ì˜ ì‚¬ìš©ì ìê²© ì¦ëª…ì´ í¬í•¨ë  ìˆ˜ ìˆìŒì„ ë‚˜íƒ€ëƒ„ (Clientì˜ credentials:include ì˜µì…˜ì¼ ê²½ìš° true í•„ìˆ˜)
5. Access-Control-Max-Age : Preflight ìš”ì²­ ê²°ê³¼ë¥¼ ìºì‹œí•  ìˆ˜ ìˆëŠ” ì‹œê°„ì„ ë‚˜íƒ€ë‚´ëŠ” ê²ƒìœ¼ë¡œ í•´ë‹¹ ì‹œê°„ ë™ì•ˆì€ Prefilght ìš”ì²­ì„ ë‹¤ì‹œ í•˜ì§€ ì•Šê²Œ ë¨

-----
### CorsConfigurer
-----
1. Spring Security í•„í„° ì²´ì¸ì— CorsFilter ì¶”ê°€
2. corsFilter ë¼ëŠ” ì´ë¦„ì˜ Beanì´ ì œê³µë˜ë©´ í•´ë‹¹ CorsFilterê°€ ì‚¬ìš©
3. corsFilter ë¼ëŠ” ì´ë¦„ì˜ Beanì´ ì—†ê³ , CorsConfigurationSource ë¹ˆì´ ì •ì˜ëœ ê²½ìš° í•´ë‹¹ CorsConfigurationì´ ì‚¬ìš©
4. CorsConfigurationSource ë¹ˆì´ ì •ì˜ë˜ì–´ ìˆì§€ ì•Šì€ ê²½ìš° Spring MVCê°€ í´ë˜ìŠ¤ ê²½ë¡œì— ìˆìœ¼ë©´ HandlerMappingIntroceptorê°€ ì‚¬ìš©

-----
### CorsFilter
-----
1. CORS ì˜ˆë¹„ ìš”ì²­ì„ ì²˜ë¦¬í•˜ê³  CORS ë‹¨ìˆœ ë° ë³¸ ìš”ì²­ì„ ê°€ë¡œì±„ê³ , ì œê³µëœ CorsConfigurationSourceë¥¼ í†µí•´ ì¼ì¹˜ëœ ì •ì±…ì— ë”°ë¼ CORS ì‘ë‹µ í—¤ë”ì™€ ê°™ì€ ì‘ë‹µì„ ì—…ë°ì´íŠ¸ í•˜ê¸° ìœ„í•œ í•„í„°
2. Spring MVC Java êµ¬ì„±ê³¼ Spring MVC XML ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ CORSë¥¼ êµ¬ì„±í•˜ëŠ” ëŒ€ì•ˆ (ì˜ˆ) @CorsOrigin)
3. ìŠ¤í”„ë§ ì›¹ì— ì˜ì¡´í•˜ëŠ” ì‘ìš© í”„ë¡œê·¸ë¨ì´ë‚˜ jakarta.servletì—ì„œ CORS ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•´ì•¼ í•˜ëŠ” ë³´ì•ˆ ì œì•½ ì¡°ê±´ì— ìœ ìš©í•œ í•„í„°

-----
### API
-----
<div align="center">
<img src="https://github.com/user-attachments/assets/beee109b-0316-4155-9c54-1d106e2fc35f">
</div>

-----
### ì½”ë“œ
-----
1. cors1 (Client)
   - templates/index.html
```html
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script>

        function corsTest(){
            fetch("http://localhost:8081/api/users",{
                method : "GET",
                headers : {
                    "Content-Type" : "text/xml",
                }
            })
                .then(response => {
                    response.json().then(function(data){
                        console.log(data)
                    })
                })
        }

    </script>
</head>
<body>
<button name="corsTest" onclick="corsTest()">corsTest</button>
</body>
</html>
```

   - Cors1Controller
```java
package io.security.cors1;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;

@Controller
public class Cors1Controller {
    
    @GetMapping("/")
    public String index() {
        return "index";
    }
}
```

2. cors2 (Server)
   - User
```java
package io.security.cors2;

public class User {
    private String username;
    private int age;

    public User(String username, int age) {
        this.username = username;
        this.age = age;
    }

    public String getUsername() {
        return username;
    }

    public int getAge() {
        return age;
    }
}
```

   - Cors2Controller
```java
package io.security.cors2;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api")
public class Cors2Controller {

    @GetMapping("/users")
    public User users() {
        return new User("user", 20);
    }
}
```

   - SecurityConfig
```java
package io.security.cors2;

import org.springframework.context.annotation.Bean;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http.authorizeHttpRequests(auth -> auth
                .anyRequest()
                .authenticated());
        
        http.cors(cors -> cors.configurationSource(corsConfigurationSource()));

        return http.build();
    }

    @Bean
    public CorsConfigurationSource corsConfigurationSource() {

        CorsConfiguration configuration = new CorsConfiguration();

        configuration.addAllowedOrigin("http://localhost:8080");
        configuration.addAllowedMethod("*");
        configuration.addAllowedHeader("*");
        configuration.setAllowCredentials(true);
        configuration.setMaxAge(1L);
        
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration);

        return source;
    }
}
```

-----
### ì„¤ì • ê³¼ì • ì½”ë“œ
-----
1. CorsConfigurer
```java
public void configure(H http) {
        ApplicationContext context = (ApplicationContext)http.getSharedObject(ApplicationContext.class);
        CorsFilter corsFilter = this.getCorsFilter(context); // CorsFilterë¥¼ ê°€ì ¸ì˜´
        Assert.state(corsFilter != null, () -> {
            return "Please configure either a corsFilter bean or a corsConfigurationSourcebean.";
        });
        http.addFilter(corsFilter);
}

private CorsFilter getCorsFilter(ApplicationContext context) {
        if (this.configurationSource != null) {
            return new CorsFilter(this.configurationSource); // ê¸°ì¡´ì— ë“±ë¡ëœ ì½”ë“œê°€ ìˆë‹¤ë©´, ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìƒì„±
        } else { // ì—†ë‹¤ë©´,
            boolean containsCorsFilter = context.containsBeanDefinition("corsFilter"); // ë¹ˆì„ ì°¾ìŒ
            if (containsCorsFilter) {
                return (CorsFilter)context.getBean("corsFilter", CorsFilter.class); // ìˆë‹¤ë©´ ì°¾ìŒ
            } else {
                boolean containsCorsSource = context.containsBean("corsConfigurationSource");
                if (containsCorsSource) {
                    CorsConfigurationSource configurationSource = (CorsConfigurationSource)context.getBean("corsConfigurationSource", CorsConfigurationSource.class);
                    return new CorsFilter(configurationSource);
                } else {
                    return mvcPresent ? CorsConfigurer.MvcCorsFilter.getMvcCorsFilter(context) : null;
                }
            }
        }
}
```

2. CorsFilter
```java
protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        CorsConfiguration corsConfiguration = this.configSource.getCorsConfiguration(request);
        boolean isValid = this.processor.processRequest(corsConfiguration, request, response);
        if (isValid && !CorsUtils.isPreFlightRequest(request)) {
            filterChain.doFilter(request, response);
        }
}
```

